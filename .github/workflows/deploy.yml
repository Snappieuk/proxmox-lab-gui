name: Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Stop running Flask app
        run: |
          pkill -9 -f "run.py" 2>/dev/null || true
          pkill -9 -f "python.*proxmox-lab-gui" 2>/dev/null || true
          lsof -ti:8080 | xargs kill -9 2>/dev/null || true
          sleep 2
          
      - name: Pull latest changes
        run: |
          cd ~/
          git pull
          
      - name: Install dependencies
        run: |
          cd ~/
          source venv/bin/activate
          pip install -r requirements.txt
          
      - name: Start Flask app
        run: |
          cd ~/
          source venv/bin/activate
          nohup python3 run.py > /tmp/flask.log 2>&1 &
          sleep 3
          
      - name: Verify Flask is running
        run: |
          if pgrep -f "run.py" > /dev/null; then
            echo "âœ“ Flask app is running"
            exit 0
          else
            echo "ERROR: Flask app failed to start!"
            tail -30 /tmp/flask.log
            exit 1
          fi
