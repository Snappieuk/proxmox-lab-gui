{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div>
        <h1>My Lab Machines</h1>
        <p class="page-subtitle">
            Windows: RDP. Linux: SSH.
        </p>
    </div>
</div>

<!-- Search box -->
<div style="margin-bottom: 2rem;">
    <form method="get" action="" style="display: flex; gap: 0.5rem; max-width: 600px;">
        <input type="text" 
               name="search" 
               placeholder="Search by name, VMID, or IP..." 
               value="{{ request.args.get('search', '') }}"
               style="flex: 1; padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        <button type="submit" class="btn-primary" style="padding: 0.5rem 1.5rem;">Search</button>
        {% if request.args.get('search') %}
        <a href="{{ request.path }}" class="btn-secondary" style="padding: 0.5rem 1rem;">Clear</a>
        {% endif %}
    </form>
</div>

    {% if message %}
    <div class="page-banner">{{ message }}</div>
    {% endif %}
    {% if probe %}
    <div class="page-banner">
        <strong>Probe:</strong>
        Nodes: {{ probe.nodes_count }}; Resources: {{ probe.resources_count }}; Valid nodes: {{ probe.valid_nodes }}
        {% if probe.error %}<br/>Error: {{ probe.error }}{% endif %}
    </div>
    {% endif %}

{% if progressive_load %}
<!-- Loading indicator -->
<div id="loading-indicator" style="padding: 3rem 0; text-align: center;">
    <div class="spinner" style="margin: 0 auto 1rem;"></div>
    <p style="color: #666; font-size: 16px;">Loading virtual machines...</p>
</div>
<style>
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>

<!-- Containers for dynamically loaded VMs -->
<div id="windows-vms-container" style="display: none;">
    <h2 class="section-title">Windows VMs</h2>
    <div class="cards-grid"></div>
</div>

<div id="linux-vms-container" style="display: none;">
    <h2 class="section-title">Linux VMs</h2>
    <div class="cards-grid"></div>
</div>

<div id="lxc-containers-container" style="display: none;">
    <h2 class="section-title">LXC Containers</h2>
    <div class="cards-grid"></div>
</div>

<div id="other-vms-container" style="display: none;">
    <h2 class="section-title">Other / unknown</h2>
    <div class="cards-grid"></div>
</div>
{% else %}
{% macro vm_cards(vms) %}
<div class="cards-grid">
    {% for vm in vms %}
    <div class="vm-card" data-vmid="{{ vm.vmid }}">
        <div class="vm-card-header">
            <div>
                <div class="vm-name">{{ vm.name }}</div>
                <div class="vm-meta">
                    VMID {{ vm.vmid }} · {{ vm.node }}
                </div>
            </div>
            <div class="vm-status vm-status-{{ vm.status }}">
                {{ vm.status|capitalize }}
            </div>
        </div>

        <div class="vm-body">
            <div class="vm-row">
                <span class="vm-label">IP address</span>
                <span class="vm-value vm-ip">
                    {% if vm.ip %}
                        {{ vm.ip }}
                    {% else %}
                        Not available
                    {% endif %}
                </span>
            </div>
            {% if vm.category == "windows" %}
            <div class="vm-row">
                <span class="vm-label">Connection</span>
                <span class="vm-value">RDP (3389)</span>
            </div>
            {% elif vm.category == "linux" %}
            <div class="vm-row">
                <span class="vm-label">Connection</span>
                <span class="vm-value">SSH (22)</span>
            </div>
            <div class="vm-row">
                <span class="vm-label">SSH command</span>
                <span class="vm-value vm-ssh">
                    {% if vm.ip %}
                        ssh &lt;user&gt;@{{ vm.ip }}
                    {% else %}
                        ssh &lt;user&gt;@&lt;ip&gt;
                    {% endif %}
                </span>
            </div>
            {% endif %}
        </div>

        <div class="vm-footer">
            <button class="btn-secondary btn-power"
                    data-vmid="{{ vm.vmid }}" data-action="stop">
                Stop
            </button>
            <button class="btn-primary btn-power"
                    data-vmid="{{ vm.vmid }}" data-action="start">
                Start
            </button>

            {% if vm.category == "windows" %}
            <a class="btn-link" href="/rdp/{{ vm.vmid }}.rdp">RDP file</a>
            {% endif %}
        </div>
    </div>
    {% else %}
    <p>No VMs in this category.</p>
    {% endfor %}
</div>
{% endmacro %}

{% if windows_vms %}
<h2 class="section-title">Windows VMs</h2>
{{ vm_cards(windows_vms) }}
{% endif %}

{% if linux_vms %}
<h2 class="section-title">Linux VMs</h2>
{{ vm_cards(linux_vms) }}
{% endif %}

{% if lxc_containers %}
<h2 class="section-title">LXC Containers</h2>
{{ vm_cards(lxc_containers) }}
{% endif %}

{% if other_vms %}
<h2 class="section-title">Other / unknown</h2>
{{ vm_cards(other_vms) }}
{% endif %}
{% endif %}

{% if progressive_load %}
<script>
// Progressive loading: fetch VMs and populate page dynamically
let isInitialLoad = true;

async function loadVMs() {
    const searchParams = new URLSearchParams(window.location.search);
    const search = searchParams.get('search') || '';
    
    try {
        const resp = await fetch("/api/vms" + (search ? "?search=" + encodeURIComponent(search) : ""));
        if (!resp.ok) {
            showMessage("Failed to load VMs");
            return;
        }
        const vms = await resp.json();
        
        // Sort VMs alphabetically by name
        vms.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        
        // Categorize VMs
        const windows_vms = vms.filter(v => v.type === "qemu" && v.category === "windows");
        const linux_vms = vms.filter(v => v.type === "qemu" && v.category === "linux");
        const lxc_containers = vms.filter(v => v.type === "lxc");
        const other_vms = vms.filter(v => v.type === "qemu" && !["windows", "linux"].includes(v.category));
        
        // Render sections
        renderVMSection("windows-vms-container", "Windows VMs", windows_vms);
        renderVMSection("linux-vms-container", "Linux VMs", linux_vms);
        renderVMSection("lxc-containers-container", "LXC Containers", lxc_containers);
        renderVMSection("other-vms-container", "Other / unknown", other_vms);
        
        // Hide loading indicator
        document.getElementById('loading-indicator')?.remove();
        
        if (vms.length === 0) {
            showMessage(search ? `No VMs found matching '${search}'` : "No VMs available");
        }
        
        isInitialLoad = false;
    } catch (e) {
        console.error("Failed to load VMs:", e);
        showMessage("Error loading VMs");
    }
}

function showMessage(text) {
    const existing = document.querySelector('.page-banner');
    if (existing) existing.textContent = text;
    else {
        const banner = document.createElement('div');
        banner.className = 'page-banner';
        banner.textContent = text;
        document.querySelector('.page-header').after(banner);
    }
}

function renderVMSection(containerId, title, vms) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (vms.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    const titleEl = container.querySelector('h2');
    if (titleEl) titleEl.textContent = title;
    
    const grid = container.querySelector('.cards-grid');
    grid.innerHTML = vms.map(vm => createVMCard(vm)).join('');
}

function createVMCard(vm) {
    const isWindows = vm.category === 'windows';
    const isLinux = vm.category === 'linux';
    const sshCommand = vm.ip ? `ssh &lt;user&gt;@${vm.ip}` : 'ssh &lt;user&gt;@&lt;ip&gt;';
    
    return `
        <div class="vm-card" data-vmid="${vm.vmid}">
            <div class="vm-card-header">
                <div>
                    <div class="vm-name">${vm.name}</div>
                    <div class="vm-meta">VMID ${vm.vmid} · ${vm.node}</div>
                </div>
                <div class="vm-status vm-status-${vm.status}">${vm.status.charAt(0).toUpperCase() + vm.status.slice(1)}</div>
            </div>
            <div class="vm-body">
                <div class="vm-row">
                    <span class="vm-label">IP address</span>
                    <span class="vm-value vm-ip">${vm.ip || 'Not available'}</span>
                </div>
                ${isWindows ? `
                <div class="vm-row">
                    <span class="vm-label">Connection</span>
                    <span class="vm-value">RDP (3389)</span>
                </div>
                ` : ''}
                ${isLinux ? `
                <div class="vm-row">
                    <span class="vm-label">Connection</span>
                    <span class="vm-value">SSH (22)</span>
                </div>
                <div class="vm-row">
                    <span class="vm-label">SSH command</span>
                    <span class="vm-value vm-ssh">${sshCommand}</span>
                </div>
                ` : ''}
            </div>
            <div class="vm-footer">
                <button class="btn-secondary btn-power" data-vmid="${vm.vmid}" data-action="stop">Stop</button>
                <button class="btn-primary btn-power" data-vmid="${vm.vmid}" data-action="start">Start</button>
                ${isWindows ? `<a class="btn-link" href="/rdp/${vm.vmid}.rdp">RDP file</a>` : ''}
            </div>
        </div>
    `;
}

async function refreshVmStatus() {
    try {
        const resp = await fetch("/api/vms");
        if (!resp.ok) return;
        const data = await resp.json();

        data.forEach(vm => {
            const card = document.querySelector('.vm-card[data-vmid="' + vm.vmid + '"]');
            if (!card) return;

            const statusEl = card.querySelector('.vm-status');
            const ipEl = card.querySelector('.vm-ip');
            const sshEl = card.querySelector('.vm-ssh');

            if (statusEl) {
                const text = vm.status ? vm.status.charAt(0).toUpperCase() + vm.status.slice(1) : "Unknown";
                statusEl.textContent = text;
                statusEl.classList.remove("vm-status-running", "vm-status-stopped", "vm-status-unknown");
                statusEl.classList.add("vm-status-" + vm.status);
            }
            if (ipEl) {
                ipEl.textContent = vm.ip ? vm.ip : "Not available";
            }
            if (sshEl) {
                if (vm.ip) {
                    sshEl.textContent = "ssh <user>@" + vm.ip;
                } else {
                    sshEl.textContent = "ssh <user>@<ip>";
                }
            }
        });
    } catch (e) {}
}

async function sendPowerAction(vmid, action, btn) {
    try {
        btn.disabled = true;
        btn.classList.add("btn-disabled");
        const resp = await fetch(`/api/vm/${vmid}/${action}`, { method: "POST" });
        if (!resp.ok) {
            console.error("Power action failed", await resp.text());
        }
        setTimeout(refreshVmStatus, 2000);
    } catch (e) {
        console.error(e);
    } finally {
        btn.disabled = false;
        btn.classList.remove("btn-disabled");
    }
}

window.addEventListener("load", function () {
    const progressiveLoad = {% if progressive_load %}true{% else %}false{% endif %};
    
    if (progressiveLoad) {
        // Load VMs immediately on page load
        loadVMs();
        // Then poll for updates every 15 seconds
        setInterval(refreshVmStatus, 15000);
    } else {
        // Delay initial refresh slightly to let page render first
        setTimeout(refreshVmStatus, 500);
        // Poll for updates every 15 seconds
        setInterval(refreshVmStatus, 15000);
    }

    document.addEventListener("click", function (e) {
        const btn = e.target.closest(".btn-power");
        if (!btn) return;
        const vmid = btn.getAttribute("data-vmid");
        const action = btn.getAttribute("data-action");
        if (!vmid || !action) return;
        sendPowerAction(vmid, action, btn);
    });
});
</script>
{% else %}
<script>
async function refreshVmStatus() {
    try {
        const resp = await fetch("/api/vms");
        if (!resp.ok) return;
        const data = await resp.json();

        data.forEach(vm => {
            const card = document.querySelector('.vm-card[data-vmid="' + vm.vmid + '"]');
            if (!card) return;

            const statusEl = card.querySelector('.vm-status');
            const ipEl = card.querySelector('.vm-ip');
            const sshEl = card.querySelector('.vm-ssh');

            if (statusEl) {
                const text = vm.status ? vm.status.charAt(0).toUpperCase() + vm.status.slice(1) : "Unknown";
                statusEl.textContent = text;
                statusEl.classList.remove("vm-status-running", "vm-status-stopped", "vm-status-unknown");
                statusEl.classList.add("vm-status-" + vm.status);
            }
            if (ipEl) {
                ipEl.textContent = vm.ip ? vm.ip : "Not available";
            }
            if (sshEl) {
                if (vm.ip) {
                    sshEl.textContent = "ssh <user>@" + vm.ip;
                } else {
                    sshEl.textContent = "ssh <user>@<ip>";
                }
            }
        });
    } catch (e) {}
}

async function sendPowerAction(vmid, action, btn) {
    try {
        btn.disabled = true;
        btn.classList.add("btn-disabled");
        const resp = await fetch(`/api/vm/${vmid}/${action}`, { method: "POST" });
        if (!resp.ok) {
            console.error("Power action failed", await resp.text());
        }
        setTimeout(refreshVmStatus, 2000);
    } catch (e) {
        console.error(e);
    } finally {
        btn.disabled = false;
        btn.classList.remove("btn-disabled");
    }
}

window.addEventListener("load", function () {
    // Delay initial refresh slightly to let page render first
    setTimeout(refreshVmStatus, 500);
    // Poll for updates every 15 seconds
    setInterval(refreshVmStatus, 15000);

    document.addEventListener("click", function (e) {
        const btn = e.target.closest(".btn-power");
        if (!btn) return;
        const vmid = btn.getAttribute("data-vmid");
        const action = btn.getAttribute("data-action");
        if (!vmid || !action) return;
        sendPowerAction(vmid, action, btn);
    });
});
</script>
{% endif %}
{% endblock %}

