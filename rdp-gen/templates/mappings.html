{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div>
        <h1>User ↔ VM mappings</h1>
        <p class="page-subtitle">
            Assign which VMs each Proxmox user (pve realm) is allowed to see/control.
        </p>
    </div>
</div>

{% if progressive_load %}
<!-- Loading indicator -->
<div id="mappings-loading" style="padding: 3rem 0; text-align: center;">
    <div class="spinner" style="margin: 0 auto 1rem;"></div>
    <p style="color: #666; font-size: 16px;">Loading mappings data...</p>
</div>
<style>
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<div id="mappings-content" style="display: none;">
{% endif %}

<div class="mapping-layout">

    <div class="mapping-form-card">
        <h2>Edit mapping</h2>

        {% if message %}
            <div class="mapping-message">{{ message }}</div>
        {% endif %}
        {% if error %}
            <div class="mapping-error">{{ error }}</div>
        {% endif %}

        <form method="post">
            <label for="user">User</label>
            <select id="user" name="user" required>
                <option value="">Select a user…</option>
                {% if not progressive_load %}
                {% for u in users %}
                    <option value="{{ u.userid }}">{{ u.userid }}</option>
                {% endfor %}
                {% endif %}
            </select>

            <label for="vmids">VM IDs (comma separated)</label>
            <input type="text" id="vmids" name="vmids"
                   placeholder="e.g. 101,102,103">

            <p class="help-text">
                Leave empty and save to remove mapping for that user.
            </p>

            <button type="submit" class="btn-primary mapping-btn">Save</button>
        </form>
    </div>

    <div class="mapping-table-card">
        <h2>Current mappings</h2>
        <table class="mapping-table">
            <thead>
            <tr>
                <th>User</th>
                <th>VM IDs</th>
            </tr>
            </thead>
            <tbody id="mappings-tbody">
            {% if not progressive_load %}
            {% if mapping %}
                {% for user_id, vmids in mapping.items() %}
                    <tr>
                        <td>{{ user_id }}</td>
                        <td>
                            {% for vmid in vmids %}
                                {{ vmid }} ({{ vm_id_to_name.get(vmid, 'unknown') }}){% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="2">No mappings defined.</td></tr>
            {% endif %}
            {% endif %}
            </tbody>
        </table>

        <p class="help-text" id="vm-list">
            {% if not progressive_load %}
            Existing VMs:
            {% for vmid in all_vm_ids %}
                {{ vmid }} ({{ vm_id_to_name.get(vmid, 'unknown') }}){% if not loop.last %}, {% endif %}
            {% endfor %}
            {% endif %}
        </p>
    </div>

</div>

{% if progressive_load %}
</div>

<script>
async function loadMappingsData() {
    try {
        const resp = await fetch("/api/mappings");
        if (!resp.ok) {
            showError("Failed to load mappings data");
            return;
        }
        const data = await resp.json();
        
        // Populate user dropdown
        const userSelect = document.getElementById('user');
        data.users.forEach(u => {
            const option = document.createElement('option');
            option.value = u.userid;
            option.textContent = u.userid;
            userSelect.appendChild(option);
        });
        
        // Populate mappings table
        const tbody = document.getElementById('mappings-tbody');
        tbody.innerHTML = '';
        
        if (Object.keys(data.mapping).length > 0) {
            Object.entries(data.mapping).forEach(([userId, vmids]) => {
                const tr = document.createElement('tr');
                const tdUser = document.createElement('td');
                tdUser.textContent = userId;
                
                const tdVMs = document.createElement('td');
                const vmNames = vmids.map(vmid => 
                    `${vmid} (${data.vm_id_to_name[vmid] || 'unknown'})`
                ).join(', ');
                tdVMs.textContent = vmNames;
                
                tr.appendChild(tdUser);
                tr.appendChild(tdVMs);
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 2;
            td.textContent = 'No mappings defined.';
            tr.appendChild(td);
            tbody.appendChild(tr);
        }
        
        // Populate VM list
        const vmList = document.getElementById('vm-list');
        const vmListText = 'Existing VMs: ' + data.all_vm_ids.map(vmid => 
            `${vmid} (${data.vm_id_to_name[vmid] || 'unknown'})`
        ).join(', ');
        vmList.textContent = vmListText;
        
        // Hide loading, show content
        document.getElementById('mappings-loading').style.display = 'none';
        document.getElementById('mappings-content').style.display = 'block';
    } catch (e) {
        console.error("Failed to load mappings:", e);
        showError("Error loading mappings data");
    }
}

function showError(message) {
    const loading = document.getElementById('mappings-loading');
    loading.innerHTML = `<p style="color: #d32f2f; font-size: 16px;">${message}</p>`;
}

window.addEventListener('load', loadMappingsData);
</script>
{% endif %}
{% endblock %}

