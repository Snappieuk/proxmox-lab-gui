{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div>
        <h1>User ↔ VM mappings</h1>
        <p class="page-subtitle">
            Assign which VMs each Proxmox user (pve realm) is allowed to see/control.
        </p>
    </div>
</div>

{% if progressive_load %}
<!-- Loading indicator -->
<div id="mappings-loading" style="padding: 3rem 0; text-align: center;">
    <div class="spinner" style="margin: 0 auto 1rem;"></div>
    <p style="color: #666; font-size: 16px;">Loading mappings data...</p>
</div>
<style>
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<div id="mappings-content" style="display: none;">
{% endif %}

<div class="mapping-layout">

    <div class="mapping-form-card">
        <h2>Manage User Access</h2>

        {% if message %}
            <div class="mapping-message">{{ message }}</div>
        {% endif %}
        {% if error %}
            <div class="mapping-error">{{ error }}</div>
        {% endif %}

        <form method="post">
            <label for="user">Select User</label>
            <select id="user" name="user" onchange="this.form.submit()" required>
                <option value="">Select a user…</option>
                {% if not progressive_load %}
                {% for u in users %}
                    <option value="{{ u.userid }}" {% if selected_user == u.userid %}selected{% endif %}>{{ u.userid }}</option>
                {% endfor %}
                {% endif %}
            </select>
        </form>

        {% if selected_user and not progressive_load %}
        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd;">
            <h3 style="font-size: 16px; margin-bottom: 1rem;">{{ selected_user }}</h3>
            
            <!-- Admin Status -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Admin Access</label>
                {% if selected_user in current_admins %}
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="admin-badge">Admin User</span>
                        {% if selected_user not in protected_admins %}
                        <form method="post" action="/admin/mappings/remove-admin-form" style="margin: 0;">
                            <input type="hidden" name="user" value="{{ selected_user }}">
                            <button type="submit" class="btn-secondary" style="padding: 0.35rem 0.75rem; font-size: 13px;" onclick="return confirm('Remove admin access from {{ selected_user }}?')">Remove Admin Access</button>
                        </form>
                        {% else %}
                        <span style="color: #666; font-size: 13px;">(Protected - defined in config)</span>
                        {% endif %}
                    </div>
                {% else %}
                    <form method="post" action="/admin/mappings/grant-admin-form" style="margin: 0;">
                        <input type="hidden" name="user" value="{{ selected_user }}">
                        <button type="submit" class="btn-primary" style="padding: 0.5rem 1rem;">Grant Admin Access</button>
                        <p class="help-text" style="margin-top: 0.5rem;">Admin users can see and control all VMs</p>
                    </form>
                {% endif %}
            </div>

            <!-- VM Mappings -->
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Assigned VMs</label>
                {% if selected_user in current_admins %}
                    <p style="color: #666; font-size: 13px; margin-bottom: 1rem;">Admin users have access to all VMs. Specific VM assignments are not needed.</p>
                {% endif %}
                
                <form method="post" action="/admin/mappings/update-vms">
                    <input type="hidden" name="user" value="{{ selected_user }}">
                    <input type="text" id="vmids" name="vmids"
                           placeholder="e.g. 101,102,103"
                           value="{% if mapping.get(selected_user) %}{{ mapping.get(selected_user)|join(',') }}{% endif %}"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.5rem;">
                    <p class="help-text">Enter VM IDs separated by commas. Leave empty to remove all mappings.</p>
                    <button type="submit" class="btn-primary mapping-btn">Update VM Assignments</button>
                </form>

                {% if mapping.get(selected_user) %}
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                    <p style="font-size: 13px; color: #666; margin-bottom: 0.5rem;">Currently assigned VMs:</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    {% for vmid in mapping.get(selected_user) %}
                        <span class="vm-mapping-item">
                            {{ vmid }} ({{ vm_id_to_name.get(vmid, 'unknown') }})
                            <form method="post" action="/admin/mappings/unassign-form" style="display: inline; margin: 0;">
                                <input type="hidden" name="user" value="{{ selected_user }}">
                                <input type="hidden" name="vmid" value="{{ vmid }}">
                                <button type="submit" class="vm-remove-btn" title="Remove this VM" onclick="return confirm('Remove VM {{ vmid }} from {{ selected_user }}?')">&times;</button>
                            </form>
                        </span>
                    {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="mapping-table-card">
        <h2>Current mappings</h2>
        <table class="mapping-table">
            <thead>
            <tr>
                <th>User</th>
                <th>VM IDs</th>
            </tr>
            </thead>
            <tbody id="mappings-tbody">
            {% if not progressive_load %}
            {% if mapping %}
                {% for user_id, vmids in mapping.items() %}
                    <tr>
                        <td>{{ user_id }}</td>
                        <td>
                            {% for vmid in vmids %}
                                <span class="vm-mapping-item">
                                    {{ vmid }} ({{ vm_id_to_name.get(vmid, 'unknown') }})
                                    <button class="vm-remove-btn" onclick="unassignVM('{{ user_id }}', {{ vmid }})" title="Remove this VM">&times;</button>
                                </span>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="2">No mappings defined.</td></tr>
            {% endif %}
            {% endif %}
            </tbody>
        </table>

        <p class="help-text" id="vm-list">
            {% if not progressive_load %}
            Existing VMs:
            {% for vmid in all_vm_ids %}
                {{ vmid }} ({{ vm_id_to_name.get(vmid, 'unknown') }}){% if not loop.last %}, {% endif %}
            {% endfor %}
            {% endif %}
        </p>
    </div>

</div>

{% if progressive_load %}
</div>

<script>
async function loadMappingsData() {
    try {
        const resp = await fetch("/api/mappings");
        if (!resp.ok) {
            showError("Failed to load mappings data");
            return;
        }
        const data = await resp.json();
        
        // Populate user dropdown
        const userSelect = document.getElementById('user');
        data.users.forEach(u => {
            const option = document.createElement('option');
            option.value = u.userid;
            option.textContent = u.userid;
            userSelect.appendChild(option);
        });
        
        // Populate mappings table
        const tbody = document.getElementById('mappings-tbody');
        tbody.innerHTML = '';
        
        if (Object.keys(data.mapping).length > 0) {
            Object.entries(data.mapping).forEach(([userId, vmids]) => {
                const tr = document.createElement('tr');
                const tdUser = document.createElement('td');
                tdUser.textContent = userId;
                
                const tdVMs = document.createElement('td');
                const vmNames = vmids.map(vmid => 
                    `${vmid} (${data.vm_id_to_name[vmid] || 'unknown'})`
                ).join(', ');
                tdVMs.textContent = vmNames;
                
                tr.appendChild(tdUser);
                tr.appendChild(tdVMs);
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 2;
            td.textContent = 'No mappings defined.';
            tr.appendChild(td);
            tbody.appendChild(tr);
        }
        
        // Populate VM list
        const vmList = document.getElementById('vm-list');
        const vmListText = 'Existing VMs: ' + data.all_vm_ids.map(vmid => 
            `${vmid} (${data.vm_id_to_name[vmid] || 'unknown'})`
        ).join(', ');
        vmList.textContent = vmListText;
        
        // Hide loading, show content
        document.getElementById('mappings-loading').style.display = 'none';
        document.getElementById('mappings-content').style.display = 'block';
    } catch (e) {
        console.error("Failed to load mappings:", e);
        showError("Error loading mappings data");
    }
}

function showError(message) {
    const loading = document.getElementById('mappings-loading');
    loading.innerHTML = `<p style="color: #d32f2f; font-size: 16px;">${message}</p>`;
}

window.addEventListener('load', loadMappingsData);
</script>
{% endif %}
<script>
function unassignVM(user, vmid) {
    if (!confirm(`Remove VM ${vmid} from ${user}?`)) {
        return;
    }
    
    fetch('/admin/mappings/unassign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ user: user, vmid: vmid })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.ok) {
            location.reload();
        } else {
            alert('Failed to unassign VM: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('Failed to unassign VM: ' + err);
    });
}

function unassignVM(user, vmid) {
    if (!confirm(`Remove VM ${vmid} from ${user}?`)) {
        return;
    }
    
    fetch('/admin/mappings/unassign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ user: user, vmid: vmid })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.ok) {
            location.reload();
        } else {
            alert('Failed to unassign VM: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('Failed to unassign VM: ' + err);
    });
}

function removeAdmin(user) {
    if (!confirm(`Remove admin access from ${user}?`)) {
        return;
    }
    
    fetch('/admin/mappings/remove-admin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ user: user })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.ok) {
            location.reload();
        } else {
            alert('Failed to remove admin: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('Failed to remove admin: ' + err);
    });
}
</script>

{% endblock %}

