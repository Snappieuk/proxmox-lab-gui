<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH - {{ vm_name }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            overflow: hidden;
        }
        #header {
            background: #2d2d30;
            padding: 8px 16px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #vm-name {
            font-size: 14px;
            font-weight: 600;
        }
        #vm-ip {
            font-size: 12px;
            color: #858585;
        }
        #status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 3px;
            background: #3a3d41;
        }
        #status.connected {
            background: #1a7f37;
            color: white;
        }
        #status.error {
            background: #a1260d;
            color: white;
        }
        #connect-bar {
            position: absolute;
            top: 40px;
            left: 0;
            right: 0;
            height: 50px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
        }
        #connect-bar label {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #ssh-username {
            background: #3c3c3c;
            border: 1px solid #5a5a5a;
            color: #d4d4d4;
            padding: 6px 10px;
            border-radius: 3px;
            font-size: 13px;
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
            width: 200px;
        }
        #ssh-username:focus {
            outline: none;
            border-color: #007acc;
            background: #454545;
        }
        #ssh-connect-btn {
            background: #0e639c;
            border: none;
            color: white;
            padding: 6px 16px;
            border-radius: 3px;
            font-size: 13px;
            cursor: pointer;
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
        }
        #ssh-connect-btn:hover {
            background: #1177bb;
        }
        #ssh-connect-btn:disabled {
            background: #3a3d41;
            cursor: not-allowed;
            opacity: 0.6;
        }
        #terminal-container {
            position: absolute;
            top: 90px;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 8px;
        }
        #terminal {
            width: 100%;
            height: 100%;
        }
        .xterm {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="header-left">
            <span id="vm-name">{{ vm_name }}</span>
            <span id="vm-ip">{{ ip }}</span>
        </div>
        <span id="status">Ready</span>
    </div>
    <div id="connect-bar">
        <label>
            Username:
            <input id="ssh-username" type="text" autocomplete="off" placeholder="Enter username">
        </label>
        <button id="ssh-connect-btn">Connect</button>
    </div>
    <div id="terminal-container">
        <div id="terminal"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script>
        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: '"Cascadia Code", "Consolas", "Courier New", monospace',
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4',
                cursor: '#ffffff',
                black: '#000000',
                red: '#cd3131',
                green: '#0dbc79',
                yellow: '#e5e510',
                blue: '#2472c8',
                magenta: '#bc3fbc',
                cyan: '#11a8cd',
                white: '#e5e5e5',
                brightBlack: '#666666',
                brightRed: '#f14c4c',
                brightGreen: '#23d18b',
                brightYellow: '#f5f543',
                brightBlue: '#3b8eea',
                brightMagenta: '#d670d6',
                brightCyan: '#29b8db',
                brightWhite: '#e5e5e5'
            }
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        window.addEventListener('resize', () => {
            fitAddon.fit();
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'resize',
                    width: term.cols,
                    height: term.rows
                }));
            }
        });

        const vmid = {{ vmid }};
        const ip = '{{ ip }}';
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        
        const status = document.getElementById('status');
        const usernameInput = document.getElementById('ssh-username');
        const connectBtn = document.getElementById('ssh-connect-btn');
        let ws = null;

        function connect() {
            const username = usernameInput.value.trim();
            if (!username) {
                term.write('\r\n\x1b[1;33mPlease enter a username\x1b[0m\r\n');
                usernameInput.focus();
                return;
            }
            
            connectBtn.disabled = true;
            usernameInput.disabled = true;
            
            const wsUrl = `${protocol}//${window.location.host}/ws/ssh/${vmid}?ip=${encodeURIComponent(ip)}&username=${encodeURIComponent(username)}`;
            
            status.textContent = 'Connecting...';
            status.className = '';
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                status.textContent = 'Connected';
                status.className = 'connected';
                term.focus();
                
                // Send initial terminal size
                ws.send(JSON.stringify({
                    type: 'resize',
                    width: term.cols,
                    height: term.rows
                }));
            };
            
            ws.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    term.write(event.data);
                }
            };
            
            ws.onerror = (error) => {
                status.textContent = 'Connection error';
                status.className = 'error';
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = (event) => {
                status.textContent = 'Disconnected';
                status.className = 'error';
                connectBtn.disabled = false;
                usernameInput.disabled = false;
                console.log('WebSocket closed:', event.code, event.reason, event.wasClean);
                term.write('\r\n\x1b[1;31mConnection closed\x1b[0m\r\n');
                if (event.reason) {
                    term.write(`\r\nReason: ${event.reason}\r\n`);
                }
            };
            
            term.onData(data => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'input', data: data }));
                }
            });
        }

        // Connect button click
        connectBtn.addEventListener('click', connect);
        
        // Enter key in username field
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connect();
            }
        });
        
        // Focus username input on load
        usernameInput.focus();
    </script>
</body>
</html>
