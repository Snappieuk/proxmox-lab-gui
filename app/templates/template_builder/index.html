{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-tools"></i> Template Builder
    </h1>
    <p class="page-subtitle">Create and manage VM templates for your classes</p>
</div>

<div class="content-container">
    <!-- Template Creation Section -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1.3rem; margin: 0;">
                <i class="bi bi-plus-circle"></i> Create New Template
            </h2>
        </div>
        <div class="card-body">
            <p style="color: #666; margin-bottom: 1.5rem;">
                Build a new VM template from scratch or convert an existing VM into a template.
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.25rem;">
                <div class="option-card" onclick="showCreateFromScratch()">
                    <div class="option-card-icon" style="background: #e6f2ff;">
                        <i class="bi bi-file-earmark-plus" style="font-size: 2.5rem; color: #0078d4;"></i>
                    </div>
                    <h3 style="font-size: 1.15rem; margin: 1rem 0 0.5rem; font-weight: 600;">Build from Scratch</h3>
                    <p style="color: #666; font-size: 0.9rem; margin: 0;">Create a new VM and configure it as a template</p>
                </div>
                
                <div class="option-card" onclick="showConvertExisting()">
                    <div class="option-card-icon" style="background: #e6f4ea;">
                        <i class="bi bi-arrow-repeat" style="font-size: 2.5rem; color: #107c10;"></i>
                    </div>
                    <h3 style="font-size: 1.15rem; margin: 1rem 0 0.5rem; font-weight: 600;">Convert Existing VM</h3>
                    <p style="color: #666; font-size: 0.9rem; margin: 0;">Turn an existing VM into a reusable template</p>
                </div>
                
                <div class="option-card" onclick="showMigrateTemplate()">
                    <div class="option-card-icon" style="background: #f3e5f5;">
                        <i class="bi bi-arrow-left-right" style="font-size: 2.5rem; color: #5c2d91;"></i>
                    </div>
                    <h3 style="font-size: 1.15rem; margin: 1rem 0 0.5rem; font-weight: 600;">Migrate Template</h3>
                    <p style="color: #666; font-size: 0.9rem; margin: 0;">Move or copy a template between clusters</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Templates Section -->
    <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
            <h2 style="font-size: 1.3rem; margin: 0;">
                <i class="bi bi-collection"></i> My Templates
            </h2>
        </div>
        <div class="card-body">
            <div id="templates-loading" style="text-align: center; padding: 2rem; color: #666;">
                <i class="bi bi-hourglass-split"></i> Loading templates...
            </div>
            <div id="templates-list" style="display: none;">
                <!-- Templates will be loaded here via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Migration Modal -->
<div id="migrate-modal" class="modal" style="display: none;">
    <div class="modal-content migration-modal">
        <div class="modal-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">
                <i class="bi bi-arrow-left-right" style="margin-right: 0.5rem;"></i>Migrate Template
            </h2>
            <button class="btn-close" onclick="closeMigrateModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.25rem 1.5rem;">
            <form id="migrate-form" onsubmit="submitMigration(event)">
                <!-- Source Section -->
                <div class="form-section">
                    <div class="section-label">Source</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="source-cluster" class="compact-label">Cluster</label>
                            <select id="source-cluster" class="form-control compact-input" onchange="updateSourceTemplates()" required>
                                <option value="">Select cluster...</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="source-template" class="compact-label">Template</label>
                            <select id="source-template" class="form-control compact-input" required>
                                <option value="">Select template...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Divider -->
                <div class="form-divider"></div>

                <!-- Destination Section -->
                <div class="form-section">
                    <div class="section-label">Destination</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="destination-cluster" class="compact-label">Cluster</label>
                            <select id="destination-cluster" class="form-control compact-input" required>
                                <option value="">Select cluster...</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="migration-operation" class="compact-label">Operation</label>
                            <select id="migration-operation" class="form-control compact-input" required>
                                <option value="copy">Copy (keep original)</option>
                                <option value="move">Move (delete original)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="modal-actions">
                    <button type="button" onclick="closeMigrateModal()" class="btn-cancel">
                        Cancel
                    </button>
                    <button type="submit" class="btn-migrate">
                        <i class="bi bi-arrow-right-circle" style="margin-right: 0.5rem;"></i>Start Migration
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Build VM Modal -->
<div id="build-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">
                <i class="bi bi-file-earmark-plus" style="margin-right: 0.5rem;"></i>Build VM from Scratch
            </h2>
            <button class="btn-close" onclick="closeBuildModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.25rem 1.5rem;">
            <form id="build-form" onsubmit="submitBuildVM(event)">
                <!-- Basic Configuration -->
                <div class="form-section">
                    <div class="section-label">Basic Configuration</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-vm-name" class="compact-label">VM Name</label>
                            <input type="text" id="build-vm-name" class="form-control compact-input" required placeholder="my-template-vm">
                        </div>
                        <div class="form-col">
                            <label for="build-os-type" class="compact-label">OS Type</label>
                            <select id="build-os-type" class="form-control compact-input" onchange="toggleOSOptions()" required>
                                <option value="ubuntu">Ubuntu</option>
                                <option value="debian">Debian</option>
                                <option value="centos">CentOS</option>
                                <option value="rocky">Rocky Linux</option>
                                <option value="alma">AlmaLinux</option>
                                <option value="windows">Windows</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-node" class="compact-label">Node</label>
                            <select id="build-node" class="form-control compact-input" onchange="loadStoragesForNode()" required>
                                <option value="">Loading nodes...</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="build-storage" class="compact-label">Storage</label>
                            <select id="build-storage" class="form-control compact-input" required>
                                <option value="local-lvm">local-lvm</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Hardware Configuration -->
                <div class="form-section">
                    <div class="section-label">Hardware</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-cpu-cores" class="compact-label">CPU Cores</label>
                            <input type="number" id="build-cpu-cores" class="form-control compact-input" min="1" max="64" value="2" required>
                        </div>
                        <div class="form-col">
                            <label for="build-memory" class="compact-label">Memory (MB)</label>
                            <input type="number" id="build-memory" class="form-control compact-input" min="512" max="65536" step="512" value="2048" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-disk-size" class="compact-label">Disk Size (GB)</label>
                            <input type="number" id="build-disk-size" class="form-control compact-input" min="8" max="2048" value="32" required>
                        </div>
                        <div class="form-col">
                            <label for="build-network-bridge" class="compact-label">Network Bridge</label>
                            <input type="text" id="build-network-bridge" class="form-control compact-input" value="vmbr0" required>
                        </div>
                    </div>
                </div>

                <!-- Linux Cloud-init Section (hidden for Windows) -->
                <div id="linux-cloudinit-section" class="form-section">
                    <div class="section-label">Cloud-init Configuration (Linux Only)</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-username" class="compact-label">Username</label>
                            <input type="text" id="build-username" class="form-control compact-input" placeholder="ubuntu">
                        </div>
                        <div class="form-col">
                            <label for="build-password" class="compact-label">Password</label>
                            <input type="password" id="build-password" class="form-control compact-input" placeholder="Leave blank for ISO install">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-use-dhcp" class="compact-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="build-use-dhcp" onchange="toggleNetworkConfig()" checked>
                                Use DHCP
                            </label>
                        </div>
                    </div>
                    <div id="static-network-config" style="display: none;">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="build-ip" class="compact-label">IP Address</label>
                                <input type="text" id="build-ip" class="form-control compact-input" placeholder="192.168.1.100">
                            </div>
                            <div class="form-col">
                                <label for="build-netmask" class="compact-label">Netmask</label>
                                <input type="text" id="build-netmask" class="form-control compact-input" placeholder="24">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="build-gateway" class="compact-label">Gateway</label>
                                <input type="text" id="build-gateway" class="form-control compact-input" placeholder="192.168.1.1">
                            </div>
                            <div class="form-col">
                                <label for="build-dns" class="compact-label">DNS Servers</label>
                                <input type="text" id="build-dns" class="form-control compact-input" placeholder="8.8.8.8,8.8.4.4">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ISO Selection (optional) -->
                <div class="form-section">
                    <div class="section-label">ISO Image (Optional)</div>
                    <div class="form-row">
                        <div class="form-col" style="grid-column: 1 / -1;">
                            <label for="build-iso" class="compact-label">Select ISO (leave blank for cloud-init)</label>
                            <select id="build-iso" class="form-control compact-input" onchange="toggleISOMode()">
                                <option value="">No ISO - Use Cloud-init</option>
                            </select>
                            <small style="color: #666; margin-top: 0.25rem; display: block;">If ISO selected, cloud-init will be disabled. You'll need to install OS manually.</small>
                        </div>
                    </div>
                </div>

                <!-- Template Options -->
                <div class="form-section">
                    <div class="section-label">Template Options</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-convert-template" class="compact-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="build-convert-template">
                                Convert to template after creation
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="modal-actions">
                    <button type="button" onclick="closeBuildModal()" class="btn-cancel">
                        Cancel
                    </button>
                    <button type="submit" class="btn-migrate">
                        <i class="bi bi-play-circle" style="margin-right: 0.5rem;"></i>Build VM
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    max-height: 90vh;
    overflow-y: auto;
}

.migration-modal {
    max-width: 550px;
    width: 90%;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e8e8e8;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 2rem;
    height: 2rem;
    line-height: 1;
    transition: color 0.2s;
}

.btn-close:hover {
    color: #333;
}

/* Form Sections */
.form-section {
    margin-bottom: 1rem;
}

.section-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #666;
    margin-bottom: 0.75rem;
}

.form-divider {
    height: 1px;
    background: #e8e8e8;
    margin: 1.25rem 0;
}

/* Two-column layout */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-col {
    display: flex;
    flex-direction: column;
}

/* Compact form controls */
.compact-label {
    display: block;
    margin-bottom: 0.4rem;
    font-weight: 500;
    font-size: 0.875rem;
    color: #333;
}

.compact-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    font-size: 0.875rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.compact-input:focus {
    outline: none;
    border-color: #0078d4;
    box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
}

/* Modal Actions */
.modal-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
    padding-top: 1.25rem;
    border-top: 1px solid #e8e8e8;
}

.btn-cancel {
    padding: 0.625rem 1.25rem;
    background: transparent;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #666;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-cancel:hover {
    background: #f5f5f5;
    border-color: #b0b0b0;
    color: #333;
}

.btn-migrate {
    padding: 0.625rem 1.5rem;
    background: #0078d4;
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0, 120, 212, 0.2);
}

.btn-migrate:hover {
    background: #106ebe;
    box-shadow: 0 4px 8px rgba(0, 120, 212, 0.3);
    transform: translateY(-1px);
}

.btn-migrate:active {
    transform: translateY(0);
}

/* Remove old styles */
.modal-body {
    /* Removed - now inline */
}

.form-group {
    /* Deprecated - using form-section instead */
}

.form-group label {
    /* Deprecated - using compact-label instead */
}

.form-control {
    /* Deprecated - using compact-input instead */
}

.form-control:focus {
    /* Deprecated - using compact-input:focus instead */
}

.option-card {
    padding: 2rem 1.5rem;
    border: 2px solid #e1e4e8;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.option-card:hover {
    border-color: #0078d4;
    background-color: #f8f9fa;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 120, 212, 0.15);
}

.option-card-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    transition: transform 0.3s ease;
}

.option-card:hover .option-card-icon {
    transform: scale(1.1);
}

.template-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    margin-bottom: 0.75rem;
    align-items: center;
}

.template-item:hover {
    background-color: #f6f8fa;
}

.template-icon {
    font-size: 2rem;
    color: #0078d4;
}

.template-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.template-name {
    font-weight: 600;
    font-size: 1.1rem;
}

.template-meta {
    color: #666;
    font-size: 0.9rem;
}

.template-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    padding: 0.5rem 1rem;
    background: #0078d4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.btn-icon:hover {
    background: #106ebe;
}

.btn-icon.btn-secondary {
    background: #6c757d;
}

.btn-icon.btn-secondary:hover {
    background: #5a6268;
}

.btn-icon.btn-danger {
    background: #dc3545;
}

.btn-icon.btn-danger:hover {
    background: #c82333;
}
</style>

<script>
function showCreateFromScratch() {
    document.getElementById('build-modal').style.display = 'flex';
    loadBuildOptions();
}

function showConvertExisting() {
    alert('Convert Existing VM - Feature coming soon!\n\nThis will let you select an existing VM and convert it to a template.');
}

async function showMigrateTemplate() {
    // Show migration modal
    document.getElementById('migrate-modal').style.display = 'flex';
    
    // Load migration options (clusters and storages)
    try {
        const response = await fetch('/api/templates/migration-options');
        const data = await response.json();
        
        if (data.ok) {
            populateMigrationOptions(data.clusters);
        } else {
            alert('Failed to load migration options: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Failed to load migration options:', error);
        alert('Failed to load migration options: ' + error.message);
    }
}

// Load user's templates
async function loadTemplates() {
    try {
        const response = await fetch('/api/templates');
        const data = await response.json();
        
        const loadingDiv = document.getElementById('templates-loading');
        const listDiv = document.getElementById('templates-list');
        
        if (!data.ok || !data.templates || data.templates.length === 0) {
            loadingDiv.innerHTML = '<p style="color: #666;">No templates found. Create your first template above!</p>';
            return;
        }
        
        loadingDiv.style.display = 'none';
        listDiv.style.display = 'block';
        
        listDiv.innerHTML = data.templates.map(template => `
            <div class="template-item">
                <div class="template-icon">
                    <i class="bi bi-hdd-stack"></i>
                </div>
                <div class="template-info">
                    <div class="template-name">${template.name || 'VM ' + template.proxmox_vmid}</div>
                    <div class="template-meta">
                        VMID: ${template.proxmox_vmid} | 
                        Node: ${template.node || 'N/A'} | 
                        ${template.cpu_cores || 2} cores, ${template.memory_mb || 2048}MB RAM
                    </div>
                </div>
                <div class="template-actions">
                    <button class="btn-icon" onclick="useTemplate(${template.id})">
                        <i class="bi bi-play-circle"></i> Use in Class
                    </button>
                    <button class="btn-icon btn-secondary" onclick="editTemplate(${template.id})">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn-icon btn-danger" onclick="deleteTemplate(${template.id})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Failed to load templates:', error);
        document.getElementById('templates-loading').innerHTML = 
            '<p style="color: #d32f2f;">Failed to load templates. Please try again.</p>';
    }
}

function useTemplate(templateId) {
    // Redirect to class creation with this template
    window.location.href = `/classes/create?template=${templateId}`;
}

function editTemplate(templateId) {
    alert(`Edit Template ${templateId} - Feature coming soon!`);
}

function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template?\n\nClasses using this template will not be affected.')) {
        return;
    }
    
    alert(`Delete Template ${templateId} - Feature coming soon!`);
}

// Load templates on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
    // Pre-load templates for migration modal
    loadTemplatesForMigration();
});

// Pre-load templates from database for instant migration modal
function loadTemplatesForMigration() {
    fetch('/api/templates')
        .then(r => r.json())
        .then(data => {
            if (data.ok && data.templates) {
                allTemplates = data.templates;
                templatesLoaded = true;
                console.log('Pre-loaded', allTemplates.length, 'templates from database');
            }
        })
        .catch(err => {
            console.error('Failed to pre-load templates:', err);
        });
}

// Migration modal functions
let migrationClusters = [];
let allTemplates = [];
let templatesLoaded = false;

async function populateMigrationOptions(clusters) {
    migrationClusters = clusters;
    
    // Ensure templates are loaded before populating
    if (!templatesLoaded) {
        console.log('Templates not loaded yet, loading now...');
        try {
            const response = await fetch('/api/templates');
            const data = await response.json();
            if (data.ok && data.templates) {
                allTemplates = data.templates;
                templatesLoaded = true;
                console.log('Loaded', allTemplates.length, 'templates');
            }
        } catch (err) {
            console.error('Failed to load templates:', err);
        }
    } else {
        console.log('Using pre-loaded templates:', allTemplates.length);
    }
    
    // Populate source clusters
    const sourceClusterSelect = document.getElementById('source-cluster');
    sourceClusterSelect.innerHTML = '<option value="">Select source cluster...</option>';
    
    clusters.forEach(cluster => {
        sourceClusterSelect.innerHTML += `<option value="${cluster.id}" data-host="${cluster.host}">
            ${cluster.name} (${cluster.host})
        </option>`;
    });
    
    // Populate destination clusters
    const destClusterSelect = document.getElementById('destination-cluster');
    destClusterSelect.innerHTML = '<option value="">Select destination cluster...</option>';
    
    clusters.forEach(cluster => {
        destClusterSelect.innerHTML += `<option value="${cluster.id}" data-host="${cluster.host}">
            ${cluster.name} (${cluster.host})
        </option>`;
    });
}

function updateSourceTemplates() {
    const sourceClusterSelect = document.getElementById('source-cluster');
    const sourceTemplateSelect = document.getElementById('source-template');
    
    const selectedClusterId = sourceClusterSelect.value;
    
    if (!selectedClusterId) {
        sourceTemplateSelect.innerHTML = '<option value="">Select a template to migrate...</option>';
        return;
    }
    
    if (!templatesLoaded || allTemplates.length === 0) {
        sourceTemplateSelect.innerHTML = '<option value="">Loading templates...</option>';
        console.log('Templates not yet loaded, waiting...');
        // Retry after templates load
        setTimeout(updateSourceTemplates, 200);
        return;
    }
    
    // Get the selected cluster's host from the option's data attribute
    const selectedOption = sourceClusterSelect.options[sourceClusterSelect.selectedIndex];
    const selectedClusterHost = selectedOption.getAttribute('data-host');
    
    console.log('=== Template Filtering Debug ===');
    console.log('Selected cluster ID:', selectedClusterId);
    console.log('Selected cluster host:', selectedClusterHost);
    console.log('Total templates loaded:', allTemplates.length);
    console.log('All templates:', JSON.stringify(allTemplates, null, 2));
    
    // Filter templates by matching cluster_ip to cluster host (instant from pre-loaded data)
    const clusterTemplates = allTemplates.filter(t => {
        const matches = t.cluster_ip === selectedClusterHost;
        console.log(`Template "${t.name}" (VMID ${t.proxmox_vmid}): cluster_ip="${t.cluster_ip}" vs host="${selectedClusterHost}" => ${matches ? 'MATCH' : 'NO MATCH'}`);
        return matches;
    });
    
    console.log('Filtered templates:', clusterTemplates.length, 'matches');
    console.log('=== End Debug ===');
    
    sourceTemplateSelect.innerHTML = '<option value="">Select a template to migrate...</option>';
    
    if (clusterTemplates.length === 0) {
        sourceTemplateSelect.innerHTML += '<option value="" disabled>No templates found on this cluster</option>';
    } else {
        clusterTemplates.forEach(template => {
            sourceTemplateSelect.innerHTML += `<option value="${template.id}">
                ${template.name || 'VM ' + template.proxmox_vmid} (VMID ${template.proxmox_vmid})
            </option>`;
        });
    }
}

function closeMigrateModal() {
    document.getElementById('migrate-modal').style.display = 'none';
    document.getElementById('migrate-form').reset();
}

async function submitMigration(event) {
    event.preventDefault();
    
    const sourceClusterId = document.getElementById('source-cluster').value;
    const sourceTemplateId = document.getElementById('source-template').value;
    const destinationClusterId = document.getElementById('destination-cluster').value;
    const operation = document.getElementById('migration-operation').value;
    const destinationStorage = 'TRUENAS-NFS';  // Default shared storage
    
    if (!sourceClusterId || !sourceTemplateId || !destinationClusterId) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (sourceClusterId === destinationClusterId) {
        alert('Source and destination clusters must be different');
        return;
    }
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Starting migration...';
    
    try {
        const response = await fetch('/api/templates/migrate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                source_template_id: parseInt(sourceTemplateId),
                source_cluster_id: sourceClusterId,
                destination_cluster_id: destinationClusterId,
                destination_storage: destinationStorage,
                operation: operation
            })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            alert(`${data.message}\\n\\nThe migration is running in the background. This may take several minutes depending on disk size.`);
            closeMigrateModal();
            
            // Refresh templates after a delay
            setTimeout(() => {
                loadTemplates();
            }, 5000);
        } else {
            alert('Migration failed: ' + (data.error || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Start Migration';
        }
    } catch (error) {
        console.error('Migration failed:', error);
        alert('Migration failed: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Start Migration';
    }
}

// Build VM from Scratch functions
async function loadBuildOptions() {
    try {
        // Load nodes
        const nodesResponse = await fetch('/api/vm-builder/nodes');
        const nodesData = await nodesResponse.json();
        
        if (nodesData.ok) {
            const nodeSelect = document.getElementById('build-node');
            nodeSelect.innerHTML = nodesData.nodes.map(node => 
                `<option value="${node.node}">${node.node}</option>`
            ).join('');
            
            // Load storages for first node
            if (nodesData.nodes.length > 0) {
                await loadStoragesForNode();
            }
        }
        
        // Load ISOs for first node
        if (nodesData.ok && nodesData.nodes.length > 0) {
            await loadISOsForNode();
        }
        
    } catch (error) {
        console.error('Failed to load build options:', error);
    }
}

async function loadStoragesForNode() {
    try {
        const node = document.getElementById('build-node').value;
        if (!node) return;
        
        const response = await fetch(`/api/vm-builder/storages?node=${node}`);
        const data = await response.json();
        
        if (data.ok) {
            const storageSelect = document.getElementById('build-storage');
            storageSelect.innerHTML = data.storages
                .filter(s => s.content.includes('images'))
                .map(storage => 
                    `<option value="${storage.storage}">${storage.storage} (${(storage.avail / 1073741824).toFixed(1)}GB free)</option>`
                ).join('');
        }
    } catch (error) {
        console.error('Failed to load storages:', error);
    }
}

async function loadISOsForNode() {
    try {
        const node = document.getElementById('build-node').value;
        if (!node) return;
        
        const response = await fetch(`/api/vm-builder/isos?node=${node}`);
        const data = await response.json();
        
        if (data.ok) {
            const isoSelect = document.getElementById('build-iso');
            const options = ['<option value="">No ISO - Use Cloud-init</option>'];
            options.push(...data.isos.map(iso => 
                `<option value="${iso.volid}">${iso.name} (${(iso.size / 1073741824).toFixed(2)}GB)</option>`
            ));
            isoSelect.innerHTML = options.join('');
        }
    } catch (error) {
        console.error('Failed to load ISOs:', error);
    }
}

function toggleOSOptions() {
    const osType = document.getElementById('build-os-type').value;
    const cloudInitSection = document.getElementById('linux-cloudinit-section');
    
    if (osType === 'windows') {
        cloudInitSection.style.display = 'none';
    } else {
        cloudInitSection.style.display = 'block';
    }
}

function toggleNetworkConfig() {
    const useDHCP = document.getElementById('build-use-dhcp').checked;
    const staticConfig = document.getElementById('static-network-config');
    
    if (useDHCP) {
        staticConfig.style.display = 'none';
    } else {
        staticConfig.style.display = 'block';
    }
}

function toggleISOMode() {
    const isoFile = document.getElementById('build-iso').value;
    const cloudInitSection = document.getElementById('linux-cloudinit-section');
    
    if (isoFile) {
        // ISO selected - hide cloud-init options
        cloudInitSection.style.opacity = '0.5';
        cloudInitSection.querySelectorAll('input').forEach(input => input.disabled = true);
    } else {
        // No ISO - enable cloud-init options
        cloudInitSection.style.opacity = '1';
        cloudInitSection.querySelectorAll('input').forEach(input => input.disabled = false);
    }
}

function closeBuildModal() {
    document.getElementById('build-modal').style.display = 'none';
    document.getElementById('build-form').reset();
}

async function submitBuildVM(event) {
    event.preventDefault();
    
    const osType = document.getElementById('build-os-type').value;
    const isoFile = document.getElementById('build-iso').value;
    const username = document.getElementById('build-username').value;
    const password = document.getElementById('build-password').value;
    
    // Validate cloud-init requirements for Linux without ISO
    if (osType !== 'windows' && !isoFile && (!username || !password)) {
        alert('For Linux VMs without ISO, you must provide username and password for cloud-init.\n\nAlternatively, select an ISO for manual installation.');
        return;
    }
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Building VM...';
    
    try {
        const formData = {
            vm_name: document.getElementById('build-vm-name').value,
            os_type: osType,
            node: document.getElementById('build-node').value,
            storage: document.getElementById('build-storage').value,
            cpu_cores: parseInt(document.getElementById('build-cpu-cores').value),
            memory_mb: parseInt(document.getElementById('build-memory').value),
            disk_size_gb: parseInt(document.getElementById('build-disk-size').value),
            network_bridge: document.getElementById('build-network-bridge').value,
            convert_to_template: document.getElementById('build-convert-template').checked
        };
        
        // Add cloud-init config if applicable
        if (osType !== 'windows' && !isoFile) {
            formData.username = username;
            formData.password = password;
            formData.use_dhcp = document.getElementById('build-use-dhcp').checked;
            
            if (!formData.use_dhcp) {
                formData.ip_address = document.getElementById('build-ip').value;
                formData.netmask = document.getElementById('build-netmask').value;
                formData.gateway = document.getElementById('build-gateway').value;
                formData.dns_servers = document.getElementById('build-dns').value;
            }
        }
        
        // Add ISO if selected
        if (isoFile) {
            formData.iso_file = isoFile;
        }
        
        const response = await fetch('/api/vm-builder/build', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.ok) {
            alert(`âœ“ ${data.message}\\n\\nVMID: ${data.vmid}`);
            closeBuildModal();
            
            // Refresh templates after a delay
            setTimeout(() => {
                loadTemplates();
            }, 3000);
        } else {
            alert('Build failed: ' + (data.error || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-play-circle"></i> Build VM';
        }
    } catch (error) {
        console.error('Build failed:', error);
        alert('Build failed: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-play-circle"></i> Build VM';
    }
}
</script>

{% endblock %}
