{% extends "base.html" %}

{% block content %}
<!-- VERSION CHECK: 2024-12-08-v4 -->
<div style="position: fixed; top: 10px; right: 10px; background: #ff0000; color: white; padding: 10px; z-index: 9999; border-radius: 5px; font-weight: bold;">
    TEMPLATE VERSION: v4
</div>

<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-tools"></i> Template Builder
    </h1>
    <p class="page-subtitle">Create and manage VM templates for your classes</p>
</div>

<div class="content-container">
    <!-- Template Creation Section -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1.3rem; margin: 0;">
                <i class="bi bi-plus-circle"></i> Create New Template
            </h2>
        </div>
        <div class="card-body">
            <p style="color: #666; margin-bottom: 1.5rem;">
                Build a new VM template from scratch or convert an existing VM into a template.
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.25rem;">
                <div class="option-card" onclick="showCreateFromScratch()">
                    <div class="option-card-icon" style="background: #e6f2ff;">
                        <i class="bi bi-file-earmark-plus" style="font-size: 2.5rem; color: #0078d4;"></i>
                    </div>
                    <h3 style="font-size: 1.15rem; margin: 1rem 0 0.5rem; font-weight: 600;">Build from Scratch</h3>
                    <p style="color: #666; font-size: 0.9rem; margin: 0;">Create a new VM and configure it as a template</p>
                </div>
                
                <div class="option-card" onclick="showConvertExisting()">
                    <div class="option-card-icon" style="background: #e6f4ea;">
                        <i class="bi bi-arrow-repeat" style="font-size: 2.5rem; color: #107c10;"></i>
                    </div>
                    <h3 style="font-size: 1.15rem; margin: 1rem 0 0.5rem; font-weight: 600;">Convert Existing VM</h3>
                    <p style="color: #666; font-size: 0.9rem; margin: 0;">Turn an existing VM into a reusable template</p>
                </div>
                
                <div class="option-card" onclick="showMigrateTemplate()">
                    <div class="option-card-icon" style="background: #f3e5f5;">
                        <i class="bi bi-arrow-left-right" style="font-size: 2.5rem; color: #5c2d91;"></i>
                    </div>
                    <h3 style="font-size: 1.15rem; margin: 1rem 0 0.5rem; font-weight: 600;">Migrate Template</h3>
                    <p style="color: #666; font-size: 0.9rem; margin: 0;">Move or copy a template between clusters</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Templates Section -->
    <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
            <h2 style="font-size: 1.3rem; margin: 0;">
                <i class="bi bi-collection"></i> My Templates
            </h2>
        </div>
        <div class="card-body">
            <div id="templates-loading" style="text-align: center; padding: 2rem; color: #666;">
                <i class="bi bi-hourglass-split"></i> Loading templates...
            </div>
            <div id="templates-list" style="display: none;">
                <!-- Templates will be loaded here via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Migration Modal -->
<div id="migrate-modal" class="modal" style="display: none;">
    <div class="modal-content migration-modal">
        <div class="modal-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">
                <i class="bi bi-arrow-left-right" style="margin-right: 0.5rem;"></i>Migrate Template
            </h2>
            <button class="btn-close" onclick="closeMigrateModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.25rem 1.5rem;">
            <form id="migrate-form" onsubmit="submitMigration(event)">
                <!-- Source Section -->
                <div class="form-section">
                    <div class="section-label">Source</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="source-cluster" class="compact-label">Cluster</label>
                            <select id="source-cluster" class="form-control compact-input" onchange="updateSourceTemplates()" required>
                                <option value="">Select cluster...</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="source-template" class="compact-label">Template</label>
                            <select id="source-template" class="form-control compact-input" required>
                                <option value="">Select template...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Divider -->
                <div class="form-divider"></div>

                <!-- Destination Section -->
                <div class="form-section">
                    <div class="section-label">Destination</div>
                    <div class="form-row">
                        <div class="form-col" style="grid-column: 1 / -1;">
                            <label for="destination-cluster" class="compact-label">Cluster</label>
                            <select id="destination-cluster" class="form-control compact-input" required>
                                <option value="">Select cluster...</option>
                            </select>
                            <small style="color: #666; margin-top: 0.5rem; display: block;">
                                Template will be copied to TRUENAS storage on the destination cluster
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="modal-actions">
                    <button type="button" onclick="closeMigrateModal()" class="btn-cancel">
                        Cancel
                    </button>
                    <button type="submit" class="btn-migrate">
                        <i class="bi bi-arrow-right-circle" style="margin-right: 0.5rem;"></i>Copy Template
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Build VM Modal -->
<div id="build-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">
                <i class="bi bi-file-earmark-plus" style="margin-right: 0.5rem;"></i>Build VM from Scratch
            </h2>
            <button class="btn-close" onclick="closeBuildModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.25rem 1.5rem;">
            <form id="build-form" onsubmit="submitBuildVM(event)">
                <!-- Basic Configuration -->
                <div class="form-section">
                    <div class="section-label">Basic Configuration</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-vm-name" class="compact-label">VM Name</label>
                            <input type="text" id="build-vm-name" class="form-control compact-input" required placeholder="my-template-vm">
                        </div>
                        <div class="form-col">
                            <label for="build-os-type" class="compact-label">OS Type</label>
                            <select id="build-os-type" class="form-control compact-input" required>
                                <option value="ubuntu">Ubuntu</option>
                                <option value="debian">Debian</option>
                                <option value="centos">CentOS</option>
                                <option value="rocky">Rocky Linux</option>
                                <option value="alma">AlmaLinux</option>
                                <option value="windows">Windows</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col" style="grid-column: 1 / -1;">
                            <label for="build-iso" class="compact-label">ISO Image</label>
                            <select id="build-iso" class="form-control compact-input" required>
                                <option value="">Loading ISOs...</option>
                            </select>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                <small style="color: #666; flex: 1;">
                                    VM will be created on TRUENAS storage. ISO location determines node.
                                </small>
                                <button type="button" onclick="openUploadISOModal()" class="btn-upload-iso">
                                    <i class="bi bi-upload"></i>Upload ISO
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hardware Configuration -->
                <div class="form-section">
                    <div class="section-label">Hardware</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-cpu-cores" class="compact-label">CPU Cores</label>
                            <input type="number" id="build-cpu-cores" class="form-control compact-input" min="1" max="64" value="2" required>
                        </div>
                        <div class="form-col">
                            <label for="build-memory" class="compact-label">Memory (MB)</label>
                            <input type="number" id="build-memory" class="form-control compact-input" min="512" max="65536" step="512" value="2048" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-disk-size" class="compact-label">Disk Size (GB)</label>
                            <input type="number" id="build-disk-size" class="form-control compact-input" min="8" max="2048" value="32" required>
                        </div>
                        <div class="form-col">
                            <label for="build-network-bridge" class="compact-label">Network Bridge</label>
                            <input type="text" id="build-network-bridge" class="form-control compact-input" value="vmbr0" required>
                        </div>
                    </div>
                </div>

                <!-- Template Options -->
                <div class="form-section">
                    <div class="section-label">Options</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="build-convert-template" class="compact-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="build-convert-template">
                                Convert to template after creation
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="modal-actions">
                    <button type="button" onclick="closeBuildModal()" class="btn-cancel">
                        Cancel
                    </button>
                    <button type="submit" class="btn-migrate">
                        <i class="bi bi-play-circle" style="margin-right: 0.5rem;"></i>Build VM
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Console Modal -->
<div id="console-modal" class="modal" style="display: none; visibility: hidden;">
    <div class="modal-content" style="max-width: 1400px; width: 95%; max-height: 95vh;">
        <div class="modal-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">
                <i class="bi bi-terminal" style="margin-right: 0.5rem;"></i>VM Console - <span id="console-vm-name"></span>
            </h2>
            <button class="btn-close" onclick="closeConsoleModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 0; height: calc(95vh - 80px);">
            <iframe id="console-frame" style="width: 100%; height: 100%; border: none;" frameborder="0"></iframe>
        </div>
    </div>
</div>

<!-- Build Success Modal -->
<div id="build-success-modal" class="modal" style="display: none; visibility: hidden;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0; color: #22c55e;">
                <i class="bi bi-check-circle" style="margin-right: 0.5rem;"></i>VM Created Successfully
            </h2>
            <button class="btn-close" onclick="closeBuildSuccessModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.5rem;">
            <p style="margin-bottom: 1rem;" id="build-success-message"></p>
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">VM ID:</div>
                <div style="font-size: 1.25rem; font-weight: 600;" id="build-success-vmid"></div>
            </div>
            <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">
                The VM has been created but is not started. You can now open the console to install the operating system.
            </p>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeBuildSuccessModal()" class="btn-cancel">
                Close
            </button>
            <button type="button" onclick="openConsoleFromSuccess()" class="btn-migrate">
                <i class="bi bi-terminal" style="margin-right: 0.5rem;"></i>Open Console
            </button>
        </div>
    </div>
</div>

<!-- Upload ISO Modal -->
<div id="upload-iso-modal" class="modal" style="display: none; visibility: hidden;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">
                <i class="bi bi-upload" style="margin-right: 0.5rem;"></i>Upload ISO Image
            </h2>
            <button class="btn-close" onclick="closeUploadISOModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.5rem;">
            <form id="upload-iso-form" onsubmit="submitUploadISO(event)">
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-col" style="grid-column: 1 / -1;">
                            <label for="upload-storage" class="compact-label">Target Storage</label>
                            <select id="upload-storage" class="form-control compact-input" disabled>
                                <option value="TRUENAS-NFS" selected>TRUENAS-NFS (Global Storage)</option>
                            </select>
                            <small style="color: #666; margin-top: 0.5rem; display: block;">
                                ISOs are automatically uploaded to TRUENAS-NFS storage, which is accessible from all nodes.
                            </small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col" style="grid-column: 1 / -1;">
                            <label for="upload-iso-file" class="compact-label">ISO File</label>
                            <input type="file" id="upload-iso-file" class="form-control compact-input" accept=".iso" required>
                            <small style="color: #666; margin-top: 0.5rem; display: block;">
                                Select an ISO file from your computer. Large files may take several minutes to upload.
                            </small>
                        </div>
                    </div>
                    <div id="upload-progress" style="display: none; margin-top: 1rem;">
                        <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem;">
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Upload Progress:</div>
                            <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="upload-progress-bar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="upload-progress-text" style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">0%</div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeUploadISOModal()" class="btn-cancel">
                        Cancel
                    </button>
                    <button type="submit" class="btn-migrate" id="upload-iso-btn">
                        <i class="bi bi-upload" style="margin-right: 0.5rem;"></i>Upload ISO
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal[style*="display: none"],
.modal[style*="visibility: hidden"] {
    display: none !important;
    visibility: hidden !important;
    pointer-events: none !important;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    max-height: 90vh;
    overflow-y: auto;
}

.migration-modal {
    max-width: 550px;
    width: 90%;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e8e8e8;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 2rem;
    height: 2rem;
    line-height: 1;
    transition: color 0.2s;
}

.btn-close:hover {
    color: #333;
}

/* Form Sections */
.form-section {
    margin-bottom: 1rem;
}

.section-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #666;
    margin-bottom: 0.75rem;
}

.form-divider {
    height: 1px;
    background: #e8e8e8;
    margin: 1.25rem 0;
}

/* Two-column layout */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-col {
    display: flex;
    flex-direction: column;
}

/* Compact form controls */
.compact-label {
    display: block;
    margin-bottom: 0.4rem;
    font-weight: 500;
    font-size: 0.875rem;
    color: #333;
}

.compact-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    font-size: 0.875rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.compact-input:focus {
    outline: none;
    border-color: #0078d4;
    box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
}

/* Modal Actions */
.modal-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
    padding-top: 1.25rem;
    border-top: 1px solid #e8e8e8;
}

.btn-cancel {
    padding: 0.625rem 1.25rem;
    background: transparent;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #666;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-cancel:hover {
    background: #f5f5f5;
    border-color: #b0b0b0;
    color: #333;
}

.btn-migrate {
    padding: 0.625rem 1.5rem;
    background: #0078d4;
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0, 120, 212, 0.2);
}

.btn-migrate:hover {
    background: #106ebe;
    box-shadow: 0 4px 8px rgba(0, 120, 212, 0.3);
    transform: translateY(-1px);
}

.btn-migrate:active {
    transform: translateY(0);
}

.btn-action {
    padding: 0.5rem 0.875rem;
    background: #0078d4;
    border: none;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 1px 3px rgba(0, 120, 212, 0.2);
}

.btn-action:hover {
    background: #106ebe;
    box-shadow: 0 2px 6px rgba(0, 120, 212, 0.3);
    transform: translateY(-1px);
}

.btn-action:active {
    transform: translateY(0);
}

.btn-action:disabled {
    background: #d1d1d1;
    cursor: not-allowed;
    box-shadow: none;
}

.btn-upload-iso {
    padding: 0.5rem 1rem;
    background: #0078d4;
    border: none;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    white-space: nowrap;
    box-shadow: 0 1px 3px rgba(0, 120, 212, 0.2);
}

.btn-upload-iso:hover {
    background: #106ebe;
    box-shadow: 0 2px 6px rgba(0, 120, 212, 0.3);
    transform: translateY(-1px);
}

.btn-upload-iso:active {
    transform: translateY(0);
}

.btn-upload-iso:disabled {
    background: #d1d1d1;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
}

.btn-upload-iso i {
    font-size: 1rem;
}

/* Remove old styles */
.modal-body {
    /* Removed - now inline */
}

.form-group {
    /* Deprecated - using form-section instead */
}

.form-group label {
    /* Deprecated - using compact-label instead */
}

.form-control {
    /* Deprecated - using compact-input instead */
}

.form-control:focus {
    /* Deprecated - using compact-input:focus instead */
}

.option-card {
    padding: 2rem 1.5rem;
    border: 2px solid #e1e4e8;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.option-card:hover {
    border-color: #0078d4;
    background-color: #f8f9fa;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 120, 212, 0.15);
}

.option-card-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    transition: transform 0.3s ease;
}

.option-card:hover .option-card-icon {
    transform: scale(1.1);
}

.template-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    margin-bottom: 0.75rem;
    align-items: center;
}

.template-item:hover {
    background-color: #f6f8fa;
}

.template-icon {
    font-size: 2rem;
    color: #0078d4;
}

.template-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.template-name {
    font-weight: 600;
    font-size: 1.1rem;
}

.template-meta {
    color: #666;
    font-size: 0.9rem;
}

.template-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    padding: 0.5rem 1rem;
    background: #0078d4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.btn-icon:hover {
    background: #106ebe;
}

.btn-icon.btn-secondary {
    background: #6c757d;
}

.btn-icon.btn-secondary:hover {
    background: #5a6268;
}

.btn-icon.btn-danger {
    background: #dc3545;
}

.btn-icon.btn-danger:hover {
    background: #c82333;
}
</style>

<script>
console.log('=== SCRIPT TAG EXECUTING - VERSION 2024-12-08-v4 ===');
console.log('Window object:', typeof window);
console.log('Document ready state:', document.readyState);

// Global variables from Flask context
const CURRENT_CLUSTER_ID = '{{ current_cluster }}';
console.log('Template Builder initialized with cluster:', CURRENT_CLUSTER_ID);

// Define functions in global scope IMMEDIATELY
function showCreateFromScratch() {
    console.log('‚úÖ showCreateFromScratch called - VERSION v3');
    document.getElementById('build-modal').style.display = 'flex';
    loadBuildOptions();
}

function showConvertExisting() {
    console.log('‚úÖ showConvertExisting called - VERSION v3');
    alert('Convert Existing VM - Feature coming soon!\n\nThis will let you select an existing VM and convert it to a template.');
}

async function showMigrateTemplate() {
    console.log('‚úÖ showMigrateTemplate called - VERSION v3');
    document.getElementById('migrate-modal').style.display = 'flex';
    
    try {
        const response = await fetch('/api/templates/migration-options');
        const data = await response.json();
        
        if (data.ok) {
            populateMigrationOptions(data.clusters);
        } else {
            alert('Failed to load migration options: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Failed to load migration options:', error);
        alert('Failed to load migration options: ' + error.message);
    }
}

// Also attach to window for redundancy
window.showCreateFromScratch = showCreateFromScratch;
window.showConvertExisting = showConvertExisting;
window.showMigrateTemplate = showMigrateTemplate;

console.log('‚úÖ Functions defined VERSION v3 - types:', typeof showCreateFromScratch, typeof showConvertExisting, typeof showMigrateTemplate);
console.log('‚úÖ Window functions VERSION v3:', typeof window.showCreateFromScratch, typeof window.showConvertExisting, typeof window.showMigrateTemplate);
console.log('‚úÖ Testing direct call...');
try {
    console.log('Can call showCreateFromScratch?', typeof showCreateFromScratch === 'function');
    console.log('Can call window.showCreateFromScratch?', typeof window.showCreateFromScratch === 'function');
} catch (e) {
    console.error('‚ùå Error testing functions:', e);
}

// Load user's templates
async function loadTemplates() {
    const loadingDiv = document.getElementById('templates-loading');
    const listDiv = document.getElementById('templates-list');
    
    try {
        console.log('üîÑ Loading templates from /api/templates...');
        console.log('Current cluster ID:', CURRENT_CLUSTER_ID);
        
        const response = await fetch('/api/templates');
        console.log('üì• Response status:', response.status, response.statusText);
        console.log('üì• Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå HTTP error:', response.status, errorText);
            loadingDiv.innerHTML = `<p style="color: #d32f2f;">Failed to load templates (HTTP ${response.status}): ${errorText}</p>`;
            return;
        }
        
        const responseText = await response.text();
        console.log('üìÑ Raw response text:', responseText.substring(0, 500));
        
        let data;
        try {
            data = JSON.parse(responseText);
            console.log('‚úÖ Parsed JSON data:', data);
        } catch (parseError) {
            console.error('‚ùå JSON parse error:', parseError);
            loadingDiv.innerHTML = '<p style="color: #d32f2f;">Invalid JSON response from server</p>';
            return;
        }
        
        if (!data.ok) {
            console.error('‚ùå API returned ok=false:', data.error);
            loadingDiv.innerHTML = `<p style="color: #d32f2f;">Failed to load templates: ${data.error || 'Unknown error'}</p>`;
            return;
        }
        
        if (!data.templates) {
            console.error('‚ùå No templates array in response, got:', Object.keys(data));
            loadingDiv.innerHTML = '<p style="color: #d32f2f;">Invalid API response format (missing templates array)</p>';
            return;
        }
        
        if (data.templates.length === 0) {
            console.log('‚ÑπÔ∏è No templates found in database');
            loadingDiv.innerHTML = '<p style="color: #666;">No templates found. Create your first template above!</p>';
            return;
        }
        
        console.log(`‚úÖ Loaded ${data.templates.length} templates:`, data.templates.map(t => `${t.name} (${t.proxmox_vmid})`));
        loadingDiv.style.display = 'none';
        listDiv.style.display = 'block';
        
        listDiv.innerHTML = data.templates.map(template => `
            <div class="template-item">
                <div class="template-icon">
                    <i class="bi bi-hdd-stack"></i>
                </div>
                <div class="template-info">
                    <div class="template-name">${template.name || 'VM ' + template.proxmox_vmid}</div>
                    <div class="template-meta">
                        VMID: ${template.proxmox_vmid} | 
                        Node: ${template.node || 'N/A'} | 
                        ${template.cpu_cores || 2} cores, ${template.memory_mb || 2048}MB RAM
                    </div>
                </div>
                <div class="template-actions">
                    <button class="btn-icon" onclick="useTemplate(${template.id})">
                        <i class="bi bi-play-circle"></i> Use in Class
                    </button>
                    <button class="btn-icon btn-secondary" onclick="editTemplate(${template.id})">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn-icon btn-danger" onclick="deleteTemplate(${template.id})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('‚ùå Exception loading templates:', error);
        console.error('Stack trace:', error.stack);
        if (loadingDiv) {
            loadingDiv.innerHTML = '<p style="color: #d32f2f;">Failed to load templates: ' + error.message + '</p>';
        }
    }
}

function useTemplate(templateId) {
    // Redirect to class creation with this template
    window.location.href = `/classes/create?template=${templateId}`;
}

function editTemplate(templateId) {
    alert(`Edit Template ${templateId} - Feature coming soon!`);
}

function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template?\n\nClasses using this template will not be affected.')) {
        return;
    }
    
    alert(`Delete Template ${templateId} - Feature coming soon!`);
}

// Load templates on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
    // Pre-load templates for migration modal
    loadTemplatesForMigration();
});

// Pre-load templates from database for instant migration modal
function loadTemplatesForMigration() {
    fetch('/api/templates')
        .then(r => r.json())
        .then(data => {
            if (data.ok && data.templates) {
                allTemplates = data.templates;
                templatesLoaded = true;
                console.log('Pre-loaded', allTemplates.length, 'templates from database');
            }
        })
        .catch(err => {
            console.error('Failed to pre-load templates:', err);
        });
}

// Migration modal functions
let migrationClusters = [];
let allTemplates = [];
let templatesLoaded = false;

async function populateMigrationOptions(clusters) {
    migrationClusters = clusters;
    
    // Ensure templates are loaded before populating
    if (!templatesLoaded) {
        console.log('Templates not loaded yet, loading now...');
        try {
            const response = await fetch('/api/templates');
            const data = await response.json();
            if (data.ok && data.templates) {
                allTemplates = data.templates;
                templatesLoaded = true;
                console.log('Loaded', allTemplates.length, 'templates');
            }
        } catch (err) {
            console.error('Failed to load templates:', err);
        }
    } else {
        console.log('Using pre-loaded templates:', allTemplates.length);
    }
    
    // Populate source clusters
    const sourceClusterSelect = document.getElementById('source-cluster');
    sourceClusterSelect.innerHTML = '<option value="">Select source cluster...</option>';
    
    clusters.forEach(cluster => {
        sourceClusterSelect.innerHTML += `<option value="${cluster.id}" data-host="${cluster.host}">
            ${cluster.name} (${cluster.host})
        </option>`;
    });
    
    // Populate destination clusters
    const destClusterSelect = document.getElementById('destination-cluster');
    destClusterSelect.innerHTML = '<option value="">Select destination cluster...</option>';
    
    clusters.forEach(cluster => {
        destClusterSelect.innerHTML += `<option value="${cluster.id}" data-host="${cluster.host}">
            ${cluster.name} (${cluster.host})
        </option>`;
    });
}

function updateSourceTemplates() {
    const sourceClusterSelect = document.getElementById('source-cluster');
    const sourceTemplateSelect = document.getElementById('source-template');
    
    const selectedClusterId = sourceClusterSelect.value;
    
    if (!selectedClusterId) {
        sourceTemplateSelect.innerHTML = '<option value="">Select a template to migrate...</option>';
        return;
    }
    
    if (!templatesLoaded || allTemplates.length === 0) {
        sourceTemplateSelect.innerHTML = '<option value="">Loading templates...</option>';
        console.log('Templates not yet loaded, waiting...');
        // Retry after templates load
        setTimeout(updateSourceTemplates, 200);
        return;
    }
    
    console.log('=== Template Filtering Debug ===');
    console.log('Selected cluster ID:', selectedClusterId);
    console.log('Total templates loaded:', allTemplates.length);
    console.log('All templates:', JSON.stringify(allTemplates, null, 2));
    
    // Filter templates by matching cluster_id (database-first approach)
    const clusterTemplates = allTemplates.filter(t => {
        const matches = t.cluster_id === selectedClusterId || t.cluster_ip === selectedClusterId;
        console.log(`Template "${t.name}" (VMID ${t.proxmox_vmid}): cluster_id="${t.cluster_id}" cluster_ip="${t.cluster_ip}" vs "${selectedClusterId}" => ${matches ? 'MATCH' : 'NO MATCH'}`);
        return matches;
    });
    
    console.log('Filtered templates:', clusterTemplates.length, 'matches');
    console.log('=== End Debug ===');
    
    sourceTemplateSelect.innerHTML = '<option value="">Select a template to migrate...</option>';
    
    if (clusterTemplates.length === 0) {
        sourceTemplateSelect.innerHTML += '<option value="" disabled>No templates found on this cluster</option>';
    } else {
        clusterTemplates.forEach(template => {
            sourceTemplateSelect.innerHTML += `<option value="${template.id}">
                ${template.name || 'VM ' + template.proxmox_vmid} (VMID ${template.proxmox_vmid})
            </option>`;
        });
    }
}

function closeMigrateModal() {
    document.getElementById('migrate-modal').style.display = 'none';
    document.getElementById('migrate-form').reset();
}

async function submitMigration(event) {
    event.preventDefault();
    
    const sourceClusterId = document.getElementById('source-cluster').value;
    const sourceTemplateId = document.getElementById('source-template').value;
    const destinationClusterId = document.getElementById('destination-cluster').value;
        const destinationStorage = 'TRUENAS-NFS';  // Hardcoded to TRUENAS-NFS storage    if (!sourceClusterId || !sourceTemplateId || !destinationClusterId) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (sourceClusterId === destinationClusterId) {
        alert('Source and destination clusters must be different');
        return;
    }
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Copying template...';
    
    try {
        const response = await fetch('/api/templates/migrate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                source_template_id: parseInt(sourceTemplateId),
                source_cluster_id: sourceClusterId,
                destination_cluster_id: destinationClusterId,
                destination_storage: destinationStorage,
                operation: 'copy'  // Always copy (never delete source)
            })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            alert(`Template copy started successfully!\\n\\n${data.message}\\n\\nThis may take several minutes depending on disk size. The template will appear in the list once the copy is complete.`);
            closeMigrateModal();
            
            // Refresh templates after a delay to show the new template
            setTimeout(() => {
                loadTemplates();
            }, 10000);  // 10 second delay
        } else {
            alert('Template copy failed: ' + (data.error || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Copy Template';
        }
    } catch (error) {
        console.error('Template copy failed:', error);
        alert('Template copy failed: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Copy Template';
    }
}

// Build VM from Scratch functions
async function loadBuildOptions() {
    try {
        // Get current cluster_id from session (injected by Flask context processor)
        const clusterId = CURRENT_CLUSTER_ID;
        console.log('Loading ISOs for cluster:', clusterId);
        
        if (!clusterId || clusterId === 'None' || clusterId === '') {
            console.error('No valid cluster ID available');
            document.getElementById('build-iso').innerHTML = '<option value="">No cluster selected - Please refresh page</option>';
            return;
        }
        
        // Load ISOs from all nodes (cached in background)
        const isoResponse = await fetch(`/api/vm-builder/isos?cluster_id=${clusterId}`);
        const isoData = await isoResponse.json();
        
        console.log('ISO response:', isoData);
        
        if (!isoData.ok) {
            console.error('ISO API returned error:', isoData.error);
            document.getElementById('build-iso').innerHTML = `<option value="">Error: ${isoData.error || 'Unknown error'}</option>`;
            return;
        }
        
        if (isoData.isos && isoData.isos.length > 0) {
            const isoSelect = document.getElementById('build-iso');
            isoSelect.innerHTML = isoData.isos.map(iso => 
                `<option value="${iso.volid}">${iso.name} - ${iso.node}/${iso.storage} (${(iso.size / 1073741824).toFixed(2)}GB)</option>`
            ).join('');
            console.log(`Loaded ${isoData.isos.length} ISOs`);
        } else {
            const isoSelect = document.getElementById('build-iso');
            isoSelect.innerHTML = '<option value="">No ISOs found - Upload ISO to TRUENAS storage first</option>';
            console.warn('No ISOs found in response');
        }
    } catch (error) {
        console.error('Failed to load build options:', error);
        document.getElementById('build-iso').innerHTML = '<option value="">Error loading ISOs - Check console</option>';
    }
}

function closeBuildModal() {
    document.getElementById('build-modal').style.display = 'none';
    document.getElementById('build-form').reset();
}

async function submitBuildVM(event) {
    event.preventDefault();
    
    const isoFile = document.getElementById('build-iso').value;
    
    // Validate ISO is selected
    if (!isoFile) {
        alert('Please select an ISO image.');
        return;
    }
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Building VM...';
    
    try {
        const formData = {
            vm_name: document.getElementById('build-vm-name').value,
            os_type: document.getElementById('build-os-type').value,
            iso_file: isoFile,
            storage: 'TRUENAS',
            cpu_cores: parseInt(document.getElementById('build-cpu-cores').value),
            memory_mb: parseInt(document.getElementById('build-memory').value),
            disk_size_gb: parseInt(document.getElementById('build-disk-size').value),
            network_bridge: document.getElementById('build-network-bridge').value,
            agent_enabled: true,  // Always enabled
            convert_to_template: document.getElementById('build-convert-template').checked
        };
        
        const response = await fetch('/api/vm-builder/build', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.ok) {
            closeBuildModal();
            
            // Show success modal with console option
            document.getElementById('build-success-message').textContent = data.message;
            document.getElementById('build-success-vmid').textContent = data.vmid;
            const successModal = document.getElementById('build-success-modal');
            successModal.setAttribute('data-vmid', data.vmid);
            successModal.setAttribute('data-vm-name', formData.vm_name);
            successModal.style.display = 'flex';
            successModal.style.visibility = 'visible';
            
            // Refresh templates after a delay
            setTimeout(() => {
                loadTemplates();
            }, 3000);
        } else {
            alert('Build failed: ' + (data.error || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-play-circle"></i> Build VM';
        }
    } catch (error) {
        console.error('Build failed:', error);
        alert('Build failed: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-play-circle"></i> Build VM';
    }
}

function closeBuildSuccessModal() {
    const modal = document.getElementById('build-success-modal');
    modal.style.display = 'none';
    modal.style.visibility = 'hidden';
}

async function openConsoleFromSuccess() {
    const modal = document.getElementById('build-success-modal');
    const vmid = modal.getAttribute('data-vmid');
    const vmName = modal.getAttribute('data-vm-name');
    
    closeBuildSuccessModal();
    await openConsole(vmid, vmName);
}

async function openConsole(vmid, vmName) {
    try {
        // Get console URL from API
        const response = await fetch(`/api/console/${vmid}/vnc`);
        const data = await response.json();
        
        if (data.ok) {
            // Set console info
            document.getElementById('console-vm-name').textContent = vmName || `VM ${vmid}`;
            document.getElementById('console-frame').src = data.console_url;
            
            // Show console modal
            const consoleModal = document.getElementById('console-modal');
            consoleModal.style.display = 'flex';
            consoleModal.style.visibility = 'visible';
        } else {
            alert('Failed to open console: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Failed to open console:', error);
        alert('Failed to open console: ' + error.message);
    }
}

function closeConsoleModal() {
    const modal = document.getElementById('console-modal');
    modal.style.display = 'none';
    modal.style.visibility = 'hidden';
    document.getElementById('console-frame').src = '';
}

// Upload ISO functions
async function openUploadISOModal() {
    // No need to load nodes - we'll auto-detect first available node with TRUENAS
    const modal = document.getElementById('upload-iso-modal');
    modal.style.display = 'flex';
    modal.style.visibility = 'visible';
}

function closeUploadISOModal() {
    const modal = document.getElementById('upload-iso-modal');
    modal.style.display = 'none';
    modal.style.visibility = 'hidden';
    document.getElementById('upload-iso-form').reset();
    document.getElementById('upload-progress').style.display = 'none';
}

async function submitUploadISO(event) {
    event.preventDefault();
    
    const fileInput = document.getElementById('upload-iso-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select an ISO file');
        return;
    }
    
    const storage = 'TRUENAS';
    
    const submitBtn = document.getElementById('upload-iso-btn');
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('upload-progress-bar');
    const progressText = document.getElementById('upload-progress-text');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Uploading...';
    
    // Show progress bar
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = 'Preparing upload...';
    
    try {
        // First, find a node with TRUENAS storage
        const nodesResp = await fetch('/api/vm-builder/nodes');
        const nodesData = await nodesResp.json();
        
        if (!nodesData.ok || !nodesData.nodes || nodesData.nodes.length === 0) {
            throw new Error('No nodes available');
        }
        
        // Use first available node (TRUENAS is global storage, accessible from all nodes)
        const node = nodesData.nodes[0].node;
        
        progressText.textContent = `Uploading to ${node}...`;
        
        // Create FormData
        const formData = new FormData();
        formData.append('content', file);
        formData.append('node', node);
        formData.append('storage', storage);
        
        // Upload with progress tracking using fetch with ReadableStream
        const xhr = new XMLHttpRequest();
        
        // Keep-alive mechanism to prevent connection timeout
        let lastProgressTime = Date.now();
        const keepAliveInterval = setInterval(() => {
            const now = Date.now();
            if (now - lastProgressTime > 30000) {
                console.warn('No progress for 30 seconds, connection may have stalled');
            }
        }, 5000);
        
        xhr.upload.addEventListener('progress', (e) => {
            lastProgressTime = Date.now();
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                const loadedMB = (e.loaded / 1048576).toFixed(1);
                const totalMB = (e.total / 1048576).toFixed(1);
                const elapsedSeconds = (Date.now() - uploadStartTime) / 1000;
                const speedMBps = (e.loaded / 1048576) / elapsedSeconds;
                
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = 
                    `${Math.round(percentComplete)}% (${loadedMB}MB / ${totalMB}MB) - ${speedMBps.toFixed(2)} MB/s`;
            }
        });
        
        xhr.addEventListener('load', async () => {
            clearInterval(keepAliveInterval);
            if (xhr.status === 200) {
                try {
                    const data = JSON.parse(xhr.responseText);
                    if (data.ok) {
                        alert('‚úì ISO uploaded successfully to TRUENAS!');
                        closeUploadISOModal();
                        // Reload ISOs
                        await loadBuildOptions();
                    } else {
                        alert('Upload failed: ' + (data.error || 'Unknown error'));
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-upload"></i> Upload ISO';
                        progressDiv.style.display = 'none';
                    }
                } catch (e) {
                    console.error('Failed to parse response:', e);
                    alert('Upload completed but response was invalid');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-upload"></i> Upload ISO';
                    progressDiv.style.display = 'none';
                }
            } else {
                console.error('Upload failed with status:', xhr.status, xhr.responseText);
                alert(`Upload failed: HTTP ${xhr.status}. ${xhr.responseText || 'Check server logs for details.'}`);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-upload"></i> Upload ISO';
                progressDiv.style.display = 'none';
            }
        });
        
        xhr.addEventListener('error', (e) => {
            clearInterval(keepAliveInterval);
            console.error('Upload error:', e);
            console.error('XHR state:', xhr.readyState, 'Status:', xhr.status);
            alert('Upload failed: Network error. The connection was interrupted. This may be due to:\n- Nginx/Apache proxy timeout\n- Network instability\n- Server resource limits\n\nCheck server logs for details.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-upload"></i> Upload ISO';
            progressDiv.style.display = 'none';
        });
        
        xhr.addEventListener('abort', () => {
            clearInterval(keepAliveInterval);
            console.log('Upload aborted');
            alert('Upload was cancelled');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-upload"></i> Upload ISO';
            progressDiv.style.display = 'none';
        });
        
        xhr.addEventListener('timeout', () => {
            clearInterval(keepAliveInterval);
            console.error('Upload timeout after 30 minutes');
            alert('Upload timed out after 30 minutes. File may be too large or connection too slow.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-upload"></i> Upload ISO';
            progressDiv.style.display = 'none';
        });
        
        const uploadStartTime = Date.now();
        xhr.open('POST', '/api/vm-builder/upload-iso');
        xhr.timeout = 1800000; // 30 minute timeout
        
        console.log('Starting upload:', file.name, 'Size:', (file.size / 1048576).toFixed(2), 'MB');
        xhr.send(formData);
        
    } catch (error) {
        console.error('Upload failed:', error);
        document.getElementById('upload-progress').style.display = 'none';
        alert('Upload failed: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-upload"></i> Upload ISO';
    }
}
</script>

{% endblock %}
