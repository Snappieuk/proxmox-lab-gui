{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div>
        <h1>User ↔ VM Mappings</h1>
        <p class="page-subtitle">
            Assign which VMs each Proxmox user can see and control.
        </p>
    </div>
</div>

<!-- Loading indicator -->
<div id="mappings-loading" style="padding: 3rem 0; text-align: center;">
    <div class="spinner" style="margin: 0 auto 1rem;"></div>
    <p style="color: #666; font-size: 16px;">Loading mappings data...</p>
</div>

<div id="mappings-content" style="display: none;">
    <div class="mapping-layout" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 1400px; margin: 0 auto;">
        <!-- VM Mappings Card -->
        <div class="mapping-form-card">
            <h2><i class="bi bi-arrow-left-right"></i> VM Mappings</h2>

            <div id="alert-container"></div>

            <!-- User Selection -->
            <label for="user-select">Select User</label>
            <select id="user-select" class="form-control">
                <option value="">Select a user…</option>
            </select>

            <!-- User Info Area (shown when user selected) -->
            <div id="user-info-area" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f9f9f9; border-radius: 6px;">
                <h3 style="font-size: 16px; margin-bottom: 0.5rem;" id="selected-user-name"></h3>
                <div id="user-classes" style="margin-bottom: 0.5rem; color: #666; font-size: 14px;">
                    <strong>Classes:</strong> <span id="user-classes-list">None</span>
                </div>
                <div id="user-current-vms" style="color: #666; font-size: 14px;">
                    <strong>Current VM Assignments:</strong> <span id="user-vms-list">None</span>
                </div>
            </div>

            <!-- VM Selection Area (shown when user selected) -->
            <div id="vm-selection-area" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd;">
                
                <!-- VM Checkboxes -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                        Assign VMs
                        <span style="font-weight: normal; color: #666; font-size: 13px;" id="selected-count">(0 selected)</span>
                    </label>
                    <p class="help-text" style="margin-bottom: 0.75rem;">
                        Select VMs this user can access.
                    </p>
                    
                    <!-- Search/Filter -->
                    <input type="text" id="vm-search" placeholder="Search VMs by ID or name..." 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.75rem;">
                    
                    <!-- Scrollable VM List -->
                    <div class="vm-checkbox-container" id="vm-checkbox-container">
                        <!-- Checkboxes populated here -->
                    </div>
                </div>

                <!-- Confirm Button -->
                <button id="confirm-btn" class="btn-primary" style="width: 100%;">
                    Confirm Selection
                </button>
            </div>
        </div>
        
        <!-- Class Assignments Card -->
        <div class="mapping-form-card">
            <h2><i class="bi bi-mortarboard"></i> Class Assignments</h2>
            
            <div id="class-alert-container"></div>
            
            <!-- Class Selection -->
            <label for="class-select">Select Class</label>
            <select id="class-select" class="form-control">
                <option value="">Select a class…</option>
            </select>
            
            <!-- Class Info Area -->
            <div id="class-info-area" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f9f9f9; border-radius: 6px;">
                <h3 style="font-size: 16px; margin-bottom: 0.5rem;" id="selected-class-name"></h3>
                <div style="margin-bottom: 0.5rem; color: #666; font-size: 14px;">
                    <strong>Teacher:</strong> <span id="class-teacher"></span>
                </div>
                <div style="color: #666; font-size: 14px;">
                    <strong>Current Students:</strong> <span id="class-students-list">None</span>
                </div>
            </div>
            
            <!-- Student Selection Area -->
            <div id="student-selection-area" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd;">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                        Assign Students
                        <span style="font-weight: normal; color: #666; font-size: 13px;" id="students-selected-count">(0 selected)</span>
                    </label>
                    <p class="help-text" style="margin-bottom: 0.75rem;">
                        Select students to enroll in this class.
                    </p>
                    
                    <!-- Search/Filter -->
                    <input type="text" id="student-search" placeholder="Search students..." 
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 0.75rem;">
                    
                    <!-- Scrollable Student List -->
                    <div class="vm-checkbox-container" id="student-checkbox-container">
                        <!-- Checkboxes populated here -->
                    </div>
                </div>
                
                <!-- Confirm Button -->
                <button id="confirm-class-btn" class="btn-primary" style="width: 100%;">
                    Update Class Enrollment
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.mapping-form-card {
    background: white;
    border: 1px solid #e1dfdd;
    border-radius: 8px;
    padding: 2rem;
}
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.form-control {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.vm-checkbox-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.75rem;
    background: #fafafa;
}

.vm-checkbox-container::-webkit-scrollbar {
    width: 12px;
}

.vm-checkbox-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.vm-checkbox-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.vm-checkbox-container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.vm-checkbox-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    margin-bottom: 0.25rem;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.15s;
}

.vm-checkbox-item:hover {
    background: #f0f7ff;
}

.vm-checkbox-item input[type="checkbox"] {
    margin-right: 0.75rem;
    cursor: pointer;
}

.vm-checkbox-item label {
    margin: 0;
    cursor: pointer;
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.vm-id-badge {
    display: inline-block;
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    font-weight: 600;
    font-size: 13px;
    margin-right: 0.5rem;
}

.vm-cluster-badge {
    display: inline-block;
    background: #f3e5f5;
    color: #7b1fa2;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    font-size: 11px;
    margin-left: 0.5rem;
}

.alert {
    padding: 0.75rem 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}

.alert-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}
</style>

<script>
let allVMs = [];
let allUsers = [];
let currentMappings = {};
let selectedUser = '';
let userClasses = {};
let allClasses = [];
let selectedClass = '';

async function loadMappingsData() {
    try {
        const resp = await fetch("/api/mappings");
        if (!resp.ok) {
            showError("Failed to load mappings data");
            return;
        }
        const data = await resp.json();
        
        allVMs = data.vms || [];
        allUsers = data.users || [];
        currentMappings = data.mapping || {};
        
        // Populate user dropdown
        const userSelect = document.getElementById('user-select');
        userSelect.innerHTML = '<option value="">Select a user…</option>';
        allUsers.forEach(u => {
            const option = document.createElement('option');
            option.value = u.userid;
            option.textContent = u.userid;
            userSelect.appendChild(option);
        });
        
        // Fetch user classes and populate class dropdown
        await loadUserClasses();
        await loadClasses();
        
        // Hide loading, show content
        document.getElementById('mappings-loading').style.display = 'none';
        document.getElementById('mappings-content').style.display = 'block';
    } catch (e) {
        console.error("Failed to load mappings:", e);
        showError("Error loading mappings data: " + e.message);
    }
}

async function loadUserClasses() {
    try {
        const resp = await fetch("/api/classes");
        if (!resp.ok) return;
        
        const data = await resp.json();
        const classes = data.classes || [];
        
        // Build a map of username -> class names
        userClasses = {};
        
        classes.forEach(cls => {
            if (cls.students) {
                cls.students.forEach(student => {
                    const username = student.username;
                    if (!userClasses[username]) {
                        userClasses[username] = [];
                    }
                    userClasses[username].push(cls.name);
                });
            }
        });
    } catch (e) {
        console.error("Failed to load user classes:", e);
    }
}

function showError(message) {
    const loading = document.getElementById('mappings-loading');
    loading.innerHTML = `<p style="color: #d32f2f; font-size: 16px;">${message}</p>`;
}

function showAlert(message, type = 'success') {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    container.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// User selection handler
document.addEventListener('DOMContentLoaded', () => {
    const userSelect = document.getElementById('user-select');
    const vmSelectionArea = document.getElementById('vm-selection-area');
    const selectedUserName = document.getElementById('selected-user-name');
    const vmCheckboxContainer = document.getElementById('vm-checkbox-container');
    const vmSearch = document.getElementById('vm-search');
    const confirmBtn = document.getElementById('confirm-btn');
    const selectedCount = document.getElementById('selected-count');
    
    userSelect.addEventListener('change', (e) => {
        selectedUser = e.target.value;
        
        if (!selectedUser) {
            document.getElementById('user-info-area').style.display = 'none';
            vmSelectionArea.style.display = 'none';
            return;
        }
        
        // Show user info area
        const userInfoArea = document.getElementById('user-info-area');
        userInfoArea.style.display = 'block';
        
        selectedUserName.textContent = selectedUser;
        
        // Get username without realm for class lookup
        const username = selectedUser.split('@')[0];
        
        // Display user's classes
        const classList = document.getElementById('user-classes-list');
        const classes = userClasses[username] || [];
        if (classes.length > 0) {
            classList.textContent = classes.join(', ');
        } else {
            classList.textContent = 'None';
        }
        
        // Display current VM assignments
        const vmsList = document.getElementById('user-vms-list');
        const userVMs = currentMappings[selectedUser] || [];
        if (userVMs.length > 0) {
            const vmNames = userVMs.map(vmid => {
                const vm = allVMs.find(v => v.vmid === vmid);
                return vm ? `${vmid} (${vm.name})` : vmid;
            });
            vmsList.textContent = vmNames.join(', ');
        } else {
            vmsList.textContent = 'None';
        }
        
        vmSelectionArea.style.display = 'block';
        
        // Render VM checkboxes
        renderVMCheckboxes();
        updateSelectedCount();
    });
    
    vmSearch.addEventListener('input', (e) => {
        renderVMCheckboxes(e.target.value.toLowerCase());
    });
    
    confirmBtn.addEventListener('click', async () => {
        const checkboxes = vmCheckboxContainer.querySelectorAll('input[type="checkbox"]:checked');
        const selectedVMIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Saving...';
        
        try {
            const resp = await fetch('/api/mappings/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user: selectedUser,
                    vmids: selectedVMIds
                })
            });
            
            const data = await resp.json();
            
            if (data.ok) {
                currentMappings[selectedUser] = data.mapping;
                if (data.mapping.length === 0) {
                    delete currentMappings[selectedUser];
                }
                
                // Update the user info display with new VM assignments
                const vmsList = document.getElementById('user-vms-list');
                const userVMs = currentMappings[selectedUser] || [];
                if (userVMs.length > 0) {
                    const vmNames = userVMs.map(vmid => {
                        const vm = allVMs.find(v => v.vmid === vmid);
                        return vm ? `${vmid} (${vm.name})` : vmid;
                    });
                    vmsList.textContent = vmNames.join(', ');
                } else {
                    vmsList.textContent = 'None';
                }
                
                showAlert(`Successfully updated mappings for ${selectedUser}`, 'success');
            } else {
                showAlert(`Failed: ${data.error}`, 'error');
            }
        } catch (e) {
            showAlert(`Error: ${e.message}`, 'error');
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm Selection';
        }
    });
});

function renderVMCheckboxes(searchTerm = '') {
    const container = document.getElementById('vm-checkbox-container');
    const userMappings = currentMappings[selectedUser] || [];
    
    container.innerHTML = '';
    
    // Filter VMs by search term
    const filteredVMs = allVMs.filter(vm => {
        if (!searchTerm) return true;
        const vmidStr = vm.vmid.toString();
        const vmName = (vm.name || '').toLowerCase();
        return vmidStr.includes(searchTerm) || vmName.includes(searchTerm);
    });
    
    if (filteredVMs.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 1rem;">No VMs found.</p>';
        return;
    }
    
    filteredVMs.forEach(vm => {
        const div = document.createElement('div');
        div.className = 'vm-checkbox-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = vm.vmid;
        checkbox.id = `vm-${vm.vmid}`;
        checkbox.checked = userMappings.includes(vm.vmid);
        checkbox.addEventListener('change', updateSelectedCount);
        
        const label = document.createElement('label');
        label.htmlFor = `vm-${vm.vmid}`;
        label.innerHTML = `
            <span>
                <span class="vm-id-badge">${vm.vmid}</span>
                ${vm.name}
            </span>
            <span class="vm-cluster-badge">${vm.cluster_name || vm.cluster_id}</span>
        `;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
    });
}

function updateSelectedCount() {
    const container = document.getElementById('vm-checkbox-container');
    const checked = container.querySelectorAll('input[type="checkbox"]:checked').length;
    document.getElementById('selected-count').textContent = `(${checked} selected)`;
}

async function loadClasses() {
    try {
        const resp = await fetch("/api/classes");
        if (!resp.ok) return;
        
        const data = await resp.json();
        allClasses = data.classes || [];
        
        const classSelect = document.getElementById('class-select');
        classSelect.innerHTML = '<option value="">Select a class…</option>';
        allClasses.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.id;
            option.textContent = `${cls.name} (${cls.enrolled_count || 0} students)`;
            classSelect.appendChild(option);
        });
        
        // Add class selection handler
        classSelect.addEventListener('change', handleClassSelection);
    } catch (e) {
        console.error("Failed to load classes:", e);
    }
}

async function handleClassSelection(e) {
    selectedClass = e.target.value;
    
    if (!selectedClass) {
        document.getElementById('class-info-area').style.display = 'none';
        document.getElementById('student-selection-area').style.display = 'none';
        return;
    }
    
    const cls = allClasses.find(c => c.id == selectedClass);
    if (!cls) return;
    
    // Show class info
    const classInfoArea = document.getElementById('class-info-area');
    classInfoArea.style.display = 'block';
    
    document.getElementById('selected-class-name').textContent = cls.name;
    document.getElementById('class-teacher').textContent = cls.teacher_name || 'Unknown';
    
    // Fetch full class details including students
    try {
        const resp = await fetch(`/api/class/${selectedClass}`);
        if (!resp.ok) return;
        
        const data = await resp.json();
        const classData = data.class;
        
        // Display current students
        const studentsList = document.getElementById('class-students-list');
        const students = classData.students || [];
        if (students.length > 0) {
            studentsList.textContent = students.map(s => s.username).join(', ');
        } else {
            studentsList.textContent = 'None';
        }
        
        // Show student selection area
        document.getElementById('student-selection-area').style.display = 'block';
        
        // Render student checkboxes
        renderStudentCheckboxes(classData);
    } catch (e) {
        console.error('Failed to load class details:', e);
    }
}

function renderStudentCheckboxes(classData) {
    const container = document.getElementById('student-checkbox-container');
    const searchInput = document.getElementById('student-search');
    
    const currentStudents = new Set((classData.students || []).map(s => s.username));
    
    // Filter users to only show those with local accounts (can be students)
    const students = allUsers.map(u => u.userid.split('@')[0]);
    const uniqueStudents = [...new Set(students)].sort();
    
    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const items = container.querySelectorAll('.vm-checkbox-item');
        items.forEach(item => {
            const label = item.querySelector('label').textContent.toLowerCase();
            item.style.display = label.includes(searchTerm) ? 'flex' : 'none';
        });
    });
    
    container.innerHTML = '';
    
    uniqueStudents.forEach(username => {
        const div = document.createElement('div');
        div.className = 'vm-checkbox-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = username;
        checkbox.id = `student-${username}`;
        checkbox.checked = currentStudents.has(username);
        checkbox.addEventListener('change', updateStudentsSelectedCount);
        
        const label = document.createElement('label');
        label.htmlFor = `student-${username}`;
        label.innerHTML = `
            <span>${username}</span>
            ${userClasses[username] ? `<span class="vm-cluster-badge">${userClasses[username].join(', ')}</span>` : ''}
        `;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
    });
    
    updateStudentsSelectedCount();
}

function updateStudentsSelectedCount() {
    const container = document.getElementById('student-checkbox-container');
    const checked = container.querySelectorAll('input[type="checkbox"]:checked').length;
    document.getElementById('students-selected-count').textContent = `(${checked} selected)`;
}

// Add confirm button handler for class enrollment
document.addEventListener('DOMContentLoaded', () => {
    const confirmClassBtn = document.getElementById('confirm-class-btn');
    
    confirmClassBtn.addEventListener('click', async () => {
        const container = document.getElementById('student-checkbox-container');
        const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
        const selectedStudents = Array.from(checkboxes).map(cb => cb.value);
        
        confirmClassBtn.disabled = true;
        confirmClassBtn.textContent = 'Saving...';
        
        try {
            const resp = await fetch(`/api/class/${selectedClass}/students`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ students: selectedStudents })
            });
            
            const data = await resp.json();
            
            if (data.ok || resp.ok) {
                showClassAlert('Successfully updated class enrollment', 'success');
                
                // Refresh class details
                const classSelect = document.getElementById('class-select');
                handleClassSelection({ target: classSelect });
                
                // Reload user classes mapping
                await loadUserClasses();
            } else {
                showClassAlert(`Failed: ${data.error || 'Unknown error'}`, 'error');
            }
        } catch (e) {
            showClassAlert(`Error: ${e.message}`, 'error');
        } finally {
            confirmClassBtn.disabled = false;
            confirmClassBtn.textContent = 'Update Class Enrollment';
        }
    });
});

function showClassAlert(message, type = 'success') {
    const container = document.getElementById('class-alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    container.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

window.addEventListener('load', loadMappingsData);
</script>

{% endblock %}
