{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div>
        <h1>{% if is_admin and request.endpoint == 'admin_view' %}Admin View - All Virtual Machines{% else %}My Lab Machines{% endif %}</h1>
        <p class="page-subtitle">
            Quick access to your Windows and Linux virtual machines
        </p>
    </div>
</div>

<!-- Summary Tiles -->
<div class="summary-tiles">
    <div class="summary-tile">
        <div class="summary-tile-title">Windows VMs</div>
        <div class="summary-tile-value" id="windows-count">{{ windows_vms|length if windows_vms else 0 }}</div>
        <div class="summary-tile-subtitle" id="windows-running">{{ windows_vms|selectattr('status', 'equalto', 'running')|list|length if windows_vms else 0 }} running</div>
    </div>
    <div class="summary-tile">
        <div class="summary-tile-title">Linux VMs</div>
        <div class="summary-tile-value" id="linux-count">{{ linux_vms|length if linux_vms else 0 }}</div>
        <div class="summary-tile-subtitle" id="linux-running">{{ linux_vms|selectattr('status', 'equalto', 'running')|list|length if linux_vms else 0 }} running</div>
    </div>
    <div class="summary-tile">
        <div class="summary-tile-title">LXC Containers</div>
        <div class="summary-tile-value" id="lxc-count">{{ lxc_containers|length if lxc_containers else 0 }}</div>
        <div class="summary-tile-subtitle" id="lxc-running">{{ lxc_containers|selectattr('status', 'equalto', 'running')|list|length if lxc_containers else 0 }} running</div>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <input type="text" 
           id="search-input"
           placeholder="Search by name, VMID, or IP..." 
           value="{{ request.args.get('search', '') }}"
           style="flex: 1; max-width: 400px; padding: 8px 12px; border: 1px solid #8a8886; border-radius: 4px; font-size: 13px;">
    <select id="category-filter" class="filter-select">
        <option value="all">All Categories</option>
        <option value="windows">Windows Only</option>
        <option value="linux">Linux Only</option>
        <option value="lxc">LXC Only</option>
    </select>
    <select id="node-filter" class="filter-select">
        <option value="all">All Nodes</option>
    </select>
    <button type="button" id="refresh-btn" class="btn-secondary" onclick="refreshVMs()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
</div>

{% if message %}
<div class="page-banner">{{ message }}</div>
{% endif %}

<!-- Windows VMs Table -->
{% if windows_vms %}
<h4 class="section-header">Windows VMs</h4>
<table class="vm-table" id="windows-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>VMID</th>
            <th>Node</th>
            <th>Status</th>
            <th>IP Address</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for vm in windows_vms %}
        <tr data-vmid="{{ vm.vmid }}" data-category="windows" data-node="{{ vm.node }}">
            <td><strong>{{ vm.name }}</strong></td>
            <td>{{ vm.vmid }}</td>
            <td>{{ vm.node }}</td>
            <td>
                <span class="badge {% if vm.status == 'running' %}badge-success{% elif vm.status == 'stopped' %}badge-danger{% else %}badge-secondary{% endif %}">
                    {% if vm.status == 'running' %}● Running{% elif vm.status == 'stopped' %}● Stopped{% else %}● Unknown{% endif %}
                </span>
            </td>
            <td class="vm-ip">{{ vm.ip or 'N/A' }}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-icon btn-icon-success btn-power" 
                            data-vmid="{{ vm.vmid }}" 
                            data-action="start"
                            data-tooltip="Start VM"
                            {% if vm.status == 'running' %}disabled{% endif %}>
                        <i class="bi bi-play-fill"></i>
                    </button>
                    <button class="btn-icon btn-icon-danger btn-power" 
                            data-vmid="{{ vm.vmid }}" 
                            data-action="stop"
                            data-tooltip="Stop VM"
                            {% if vm.status == 'stopped' %}disabled{% endif %}>
                        <i class="bi bi-stop-fill"></i>
                    </button>
                    <a class="btn-icon btn-icon-primary" 
                       href="/rdp/{{ vm.vmid }}.rdp"
                       data-tooltip="Download RDP File">
                        <i class="bi bi-download"></i>
                    </a>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<!-- Linux VMs Table -->
{% if linux_vms %}
<h4 class="section-header">Linux VMs</h4>
<table class="vm-table" id="linux-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>VMID</th>
            <th>Node</th>
            <th>Status</th>
            <th>IP Address</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for vm in linux_vms %}
        <tr data-vmid="{{ vm.vmid }}" data-category="linux" data-node="{{ vm.node }}">
            <td><strong>{{ vm.name }}</strong></td>
            <td>{{ vm.vmid }}</td>
            <td>{{ vm.node }}</td>
            <td>
                <span class="badge {% if vm.status == 'running' %}badge-success{% elif vm.status == 'stopped' %}badge-danger{% else %}badge-secondary{% endif %}">
                    {% if vm.status == 'running' %}● Running{% elif vm.status == 'stopped' %}● Stopped{% else %}● Unknown{% endif %}
                </span>
            </td>
            <td class="vm-ip">{{ vm.ip or 'N/A' }}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-icon btn-icon-success btn-power" 
                            data-vmid="{{ vm.vmid }}" 
                            data-action="start"
                            data-tooltip="Start VM"
                            {% if vm.status == 'running' %}disabled{% endif %}>
                        <i class="bi bi-play-fill"></i>
                    </button>
                    <button class="btn-icon btn-icon-danger btn-power" 
                            data-vmid="{{ vm.vmid }}" 
                            data-action="stop"
                            data-tooltip="Stop VM"
                            {% if vm.status == 'stopped' %}disabled{% endif %}>
                        <i class="bi bi-stop-fill"></i>
                    </button>
                    <button class="btn-icon btn-icon-dark btn-ssh-web" 
                            data-vmid="{{ vm.vmid }}"
                            data-ip="{{ vm.ip or '' }}"
                            data-name="{{ vm.name }}"
                            data-tooltip="Open Web SSH Terminal"
                            {% if not vm.ip %}disabled{% endif %}>
                        <i class="bi bi-terminal"></i>
                    </button>
                    <button class="btn-icon btn-icon-dark btn-ssh-copy" 
                            data-vmid="{{ vm.vmid }}"
                            data-ip="{{ vm.ip or '' }}"
                            data-tooltip="Copy SSH Command"
                            {% if not vm.ip %}disabled{% endif %}>
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<!-- LXC Containers Table -->
{% if lxc_containers %}
<h4 class="section-header">LXC Containers</h4>
<table class="vm-table" id="lxc-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>VMID</th>
            <th>Node</th>
            <th>Status</th>
            <th>IP Address</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for vm in lxc_containers %}
        <tr data-vmid="{{ vm.vmid }}" data-category="lxc" data-node="{{ vm.node }}">
            <td><strong>{{ vm.name }}</strong></td>
            <td>{{ vm.vmid }}</td>
            <td>{{ vm.node }}</td>
            <td>
                <span class="badge {% if vm.status == 'running' %}badge-success{% elif vm.status == 'stopped' %}badge-danger{% else %}badge-secondary{% endif %}">
                    {% if vm.status == 'running' %}● Running{% elif vm.status == 'stopped' %}● Stopped{% else %}● Unknown{% endif %}
                </span>
            </td>
            <td class="vm-ip">{{ vm.ip or 'N/A' }}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-icon btn-icon-success btn-power" 
                            data-vmid="{{ vm.vmid }}" 
                            data-action="start"
                            data-tooltip="Start Container"
                            {% if vm.status == 'running' %}disabled{% endif %}>
                        <i class="bi bi-play-fill"></i>
                    </button>
                    <button class="btn-icon btn-icon-danger btn-power" 
                            data-vmid="{{ vm.vmid }}" 
                            data-action="stop"
                            data-tooltip="Stop Container"
                            {% if vm.status == 'stopped' %}disabled{% endif %}>
                        <i class="bi bi-stop-fill"></i>
                    </button>
                    <button class="btn-icon btn-icon-dark btn-ssh-web" 
                            data-vmid="{{ vm.vmid }}"
                            data-ip="{{ vm.ip or '' }}"
                            data-name="{{ vm.name }}"
                            data-tooltip="Open Web SSH Terminal"
                            {% if not vm.ip %}disabled{% endif %}>
                        <i class="bi bi-terminal"></i>
                    </button>
                    <button class="btn-icon btn-icon-dark btn-ssh-copy" 
                            data-vmid="{{ vm.vmid }}"
                            data-ip="{{ vm.ip or '' }}"
                            data-tooltip="Copy SSH Command"
                            {% if not vm.ip %}disabled{% endif %}>
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if other_vms %}
<h4 class="section-header">Other / Unknown</h4>
<table class="vm-table" id="other-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>VMID</th>
            <th>Node</th>
            <th>Status</th>
            <th>IP Address</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for vm in other_vms %}
        <tr data-vmid="{{ vm.vmid }}" data-category="other" data-node="{{ vm.node }}">
            <td><strong>{{ vm.name }}</strong></td>
            <td>{{ vm.vmid }}</td>
            <td>{{ vm.node }}</td>
            <td>
                <span class="badge {% if vm.status == 'running' %}badge-success{% elif vm.status == 'stopped' %}badge-danger{% else %}badge-secondary{% endif %}">
                    {% if vm.status == 'running' %}● Running{% elif vm.status == 'stopped' %}● Stopped{% else %}● Unknown{% endif %}
                </span>
            </td>
            <td class="vm-ip">{{ vm.ip or 'N/A' }}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-icon btn-icon-success btn-power" 
                            data-vmid="{{ vm.vmid }}" 
                            data-action="start"
                            data-tooltip="Start"
                            {% if vm.status == 'running' %}disabled{% endif %}>
                        <i class="bi bi-play-fill"></i>
                    </button>
                    <button class="btn-icon btn-icon-danger btn-power" 
                            data-vmid="{{ vm.vmid }}" 
                            data-action="stop"
                            data-tooltip="Stop"
                            {% if vm.status == 'stopped' %}disabled{% endif %}>
                        <i class="bi bi-stop-fill"></i>
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<script>
// Populate node filter
window.addEventListener('load', function() {
    const nodes = new Set();
    document.querySelectorAll('[data-node]').forEach(el => {
        nodes.add(el.getAttribute('data-node'));
    });
    const nodeFilter = document.getElementById('node-filter');
    nodes.forEach(node => {
        const option = document.createElement('option');
        option.value = node;
        option.textContent = node;
        nodeFilter.appendChild(option);
    });
});

// Search and filter functionality
document.getElementById('search-input').addEventListener('input', applyFilters);
document.getElementById('category-filter').addEventListener('change', applyFilters);
document.getElementById('node-filter').addEventListener('change', applyFilters);

function applyFilters() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const categoryFilter = document.getElementById('category-filter').value;
    const nodeFilter = document.getElementById('node-filter').value;
    
    document.querySelectorAll('.vm-table tbody tr').forEach(row => {
        const vmid = row.getAttribute('data-vmid');
        const category = row.getAttribute('data-category');
        const node = row.getAttribute('data-node');
        const text = row.textContent.toLowerCase();
        
        const matchesSearch = !searchTerm || text.includes(searchTerm);
        const matchesCategory = categoryFilter === 'all' || category === categoryFilter;
        const matchesNode = nodeFilter === 'all' || node === nodeFilter;
        
        row.style.display = (matchesSearch && matchesCategory && matchesNode) ? '' : 'none';
    });
    
    // Hide empty tables
    document.querySelectorAll('.vm-table').forEach(table => {
        const visibleRows = table.querySelectorAll('tbody tr[style=""]').length;
        const header = table.previousElementSibling;
        if (visibleRows === 0) {
            table.style.display = 'none';
            if (header && header.classList.contains('section-header')) {
                header.style.display = 'none';
            }
        } else {
            table.style.display = '';
            if (header && header.classList.contains('section-header')) {
                header.style.display = '';
            }
        }
    });
}

// Refresh VM status
async function refreshVmStatus() {
    try {
        const resp = await fetch("/api/vms");
        if (!resp.ok) return;
        const data = await resp.json();

        data.forEach(vm => {
            const row = document.querySelector(`tr[data-vmid="${vm.vmid}"]`);
            if (!row) return;

            // Update status badge
            const badge = row.querySelector('.badge');
            if (badge) {
                badge.className = 'badge';
                badge.classList.add(vm.status === 'running' ? 'badge-success' : 
                                  vm.status === 'stopped' ? 'badge-danger' : 'badge-secondary');
                badge.textContent = vm.status === 'running' ? '● Running' :
                                   vm.status === 'stopped' ? '● Stopped' : '● Unknown';
            }

            // Update IP
            const ipCell = row.querySelector('.vm-ip');
            if (ipCell) {
                ipCell.textContent = vm.ip || 'N/A';
            }

            // Update power buttons
            const startBtn = row.querySelector('.btn-power[data-action="start"]');
            const stopBtn = row.querySelector('.btn-power[data-action="stop"]');
            if (startBtn) startBtn.disabled = vm.status === 'running';
            if (stopBtn) stopBtn.disabled = vm.status === 'stopped';

            // Update SSH buttons
            row.querySelectorAll('.btn-ssh-web, .btn-ssh-copy').forEach(btn => {
                btn.disabled = !vm.ip;
                if (vm.ip) {
                    btn.setAttribute('data-ip', vm.ip);
                }
            });
        });
        
        // Update summary tiles
        updateSummaryTiles(data);
    } catch (e) {
        console.error('Failed to refresh:', e);
    }
}

function updateSummaryTiles(vms) {
    const windows = vms.filter(v => v.category === 'windows');
    const linux = vms.filter(v => v.category === 'linux');
    const lxc = vms.filter(v => v.type === 'lxc');
    
    document.getElementById('windows-count').textContent = windows.length;
    document.getElementById('windows-running').textContent = windows.filter(v => v.status === 'running').length + ' running';
    
    document.getElementById('linux-count').textContent = linux.length;
    document.getElementById('linux-running').textContent = linux.filter(v => v.status === 'running').length + ' running';
    
    document.getElementById('lxc-count').textContent = lxc.length;
    document.getElementById('lxc-running').textContent = lxc.filter(v => v.status === 'running').length + ' running';
}

// Power actions
async function sendPowerAction(vmid, action, btn) {
    try {
        btn.disabled = true;
        const resp = await fetch(`/api/vm/${vmid}/${action}`, { method: "POST" });
        if (!resp.ok) {
            console.error("Power action failed");
        }
        setTimeout(refreshVmStatus, 2000);
    } catch (e) {
        console.error(e);
    } finally {
        btn.disabled = false;
    }
}

// Refresh cache
async function refreshVMs() {
    const btn = document.getElementById('refresh-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refreshing...';
    
    try {
        const resp = await fetch("/api/vms?force_refresh=true");
        if (resp.ok) {
            await refreshVmStatus();
        }
    } catch (e) {
        console.error(e);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh';
    }
}

// Event listeners
window.addEventListener("load", function () {
    // Initial refresh after page load
    setTimeout(refreshVmStatus, 500);
    // Poll every 15 seconds
    setInterval(refreshVmStatus, 15000);

    // Power button clicks
    document.addEventListener("click", function (e) {
        const btn = e.target.closest(".btn-power");
        if (!btn) return;
        const vmid = btn.getAttribute("data-vmid");
        const action = btn.getAttribute("data-action");
        if (!vmid || !action) return;
        sendPowerAction(vmid, action, btn);
    });

    // SSH copy button
    document.addEventListener("click", function (e) {
        const btn = e.target.closest(".btn-ssh-copy");
        if (!btn || btn.disabled) return;
        const ip = btn.getAttribute("data-ip");
        if (!ip) return;
        
        const sshCommand = `ssh root@${ip}`;
        navigator.clipboard.writeText(sshCommand).then(() => {
            const icon = btn.querySelector('i');
            icon.className = 'bi bi-check-lg';
            setTimeout(() => {
                icon.className = 'bi bi-clipboard';
            }, 2000);
        }).catch(() => {
            alert(`SSH command:\n${sshCommand}`);
        });
    });

    // Web SSH button
    document.addEventListener("click", function (e) {
        const btn = e.target.closest(".btn-ssh-web");
        if (!btn || btn.disabled) return;
        const vmid = btn.getAttribute("data-vmid");
        const ip = btn.getAttribute("data-ip");
        const name = btn.getAttribute("data-name");
        if (!ip || !vmid) return;
        
        const width = 1000;
        const height = 600;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        window.open(
            `/ssh/${vmid}?ip=${encodeURIComponent(ip)}&name=${encodeURIComponent(name)}`,
            `ssh-${vmid}`,
            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=no,status=no,toolbar=no,menubar=no`
        );
    });
});
</script>

{% endblock %}
