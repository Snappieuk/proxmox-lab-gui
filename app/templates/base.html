<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lab VM Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<header class="topbar">
    <div class="topbar-left">
        <span class="logo-square"></span>
        <span class="topbar-title">Lab VMs</span>
    </div>
    <div class="topbar-right">
        {% if session.get("user") %}
            <span class="topbar-user">
                {{ session.get("user") }}
                {% if local_user_role %}
                    <span class="role-badge role-{{ local_user_role }}">{{ local_user_role }}</span>
                {% endif %}
            </span>
            <a href="{{ url_for('auth.logout') }}" class="topbar-link">Sign out</a>
        {% endif %}
    </div>
</header>

<div class="app-shell">
    <nav class="sidebar">
        {% if session.get("user") and is_admin %}
        <div class="cluster-selector">
            <label for="cluster-select" class="cluster-label">
                <i class="bi bi-hdd-rack"></i> Cluster
            </label>
            <select id="cluster-select" class="cluster-dropdown" onchange="filterByCluster(this.value)">
                <option value="all">All Clusters</option>
                {% for cluster in clusters %}
                <option value="{{ cluster.id }}">
                    {{ cluster.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div class="sidebar-section-title">Navigation</div>
        {% if session.get("user") %}
            <a class="sidebar-link {% if request.endpoint == 'portal.portal' %}sidebar-link-active{% endif %}"
               href="{{ url_for('portal.portal') }}">
                <i class="bi bi-pc-display"></i> My machines
            </a>
            <a class="sidebar-link {% if request.endpoint and 'classes' in request.endpoint %}sidebar-link-active{% endif %}"
               href="{{ url_for('classes.classes_list') }}">
                <i class="bi bi-mortarboard"></i> Classes
            </a>
            {% if is_admin or local_user_role == 'teacher' or local_user_role == 'adminer' %}
                <div class="sidebar-section-title" style="margin-top: 1rem;">Management</div>
            {% endif %}
            {% if is_admin %}
                <a class="sidebar-link {% if request.endpoint == 'admin_diagnostics.admin_view' %}sidebar-link-active{% endif %}"
                   href="{{ url_for('admin_diagnostics.admin_view') }}">
                    <i class="bi bi-eye"></i> Admin view
                </a>
                <a class="sidebar-link {% if request.endpoint == 'admin_users.users_management' %}sidebar-link-active{% endif %}"
                   href="{{ url_for('admin_users.users_management') }}">
                    <i class="bi bi-people"></i> User management
                </a>
                <a class="sidebar-link {% if request.endpoint == 'admin_mappings.admin_mappings' %}sidebar-link-active{% endif %}"
                   href="{{ url_for('admin_mappings.admin_mappings') }}">
                    <i class="bi bi-arrow-left-right"></i> Mappings
                </a>
                <a class="sidebar-link {% if request.endpoint == 'admin_diagnostics.admin_probe' %}sidebar-link-active{% endif %}"
                   href="{{ url_for('admin_diagnostics.admin_probe') }}">
                    <i class="bi bi-activity"></i> Proxmox probe
                </a>
            {% endif %}
    {% endif %}
    
    {% if session.get("user") and is_admin %}
    <div class="sidebar-settings">
        <a class="sidebar-link sidebar-link-settings {% if request.endpoint == 'admin_clusters.admin_settings' %}sidebar-link-active{% endif %}"
           href="{{ url_for('admin_clusters.admin_settings') }}">
            <i class="bi bi-gear-fill"></i> Settings
        </a>
    </div>
    {% endif %}
</nav>


    <main class="main">
        {% block content %}{% endblock %}
    </main>
</div>

<script>
function filterByCluster(clusterId) {
    console.log('Filtering VMs by cluster:', clusterId);
    
    // Store selected cluster in sessionStorage
    if (clusterId === 'all') {
        sessionStorage.removeItem('selected_cluster');
    } else {
        sessionStorage.setItem('selected_cluster', clusterId);
    }
    
    // Trigger re-render of VM tables with filter
    if (typeof window.filterVMsByCluster === 'function') {
        window.filterVMsByCluster(clusterId);
    } else {
        console.warn('filterVMsByCluster function not found, page may need to reload');
    }
}
</script>
</body>
</html>

