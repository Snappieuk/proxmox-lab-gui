{% extends "base.html" %}

{% block content %}
<div class="admin-container">
    <h2 class="page-title">Cluster Management</h2>
    <p class="page-description">Configure and manage Proxmox cluster connections. All changes are saved to the database and persist across restarts.</p>
    
    <div class="settings-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">Configured Clusters</h3>
                <p class="section-description">Add, edit, and manage your Proxmox clusters with deployment options.</p>
            </div>
            <button class="btn btn-primary" onclick="showAddClusterModal()">
                Add Cluster
            </button>
        </div>
        
        <div id="clusters-list" class="clusters-grid"></div>
        
        <div id="empty-state" class="empty-state" style="display: none;">
            <h3>No Clusters Configured</h3>
            <p>Add your first Proxmox cluster to get started</p>
            <button class="btn btn-primary" onclick="showAddClusterModal()">
                Add First Cluster
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Cluster Modal -->
<div id="cluster-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="modal-title">Add Cluster</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <form id="cluster-form" onsubmit="saveCluster(event)">
                <input type="hidden" id="cluster-db-id">
                
                <div class="form-section">
                    <h4>Connection Details</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="cluster-id">Cluster ID *</label>
                            <input type="text" id="cluster-id" required placeholder="e.g., cluster1">
                            <small>Unique identifier for this cluster</small>
                        </div>
                        <div class="form-group">
                            <label for="cluster-name">Display Name *</label>
                            <input type="text" id="cluster-name" required placeholder="e.g., Main Cluster">
                        </div>
                        <div class="form-group">
                            <label for="cluster-host">Proxmox Host *</label>
                            <input type="text" id="cluster-host" required placeholder="e.g., 10.220.15.249">
                        </div>
                        <div class="form-group">
                            <label for="cluster-port">API Port</label>
                            <input type="number" id="cluster-port" value="8006" min="1" max="65535">
                        </div>
                        <div class="form-group">
                            <label for="cluster-user">Admin User *</label>
                            <input type="text" id="cluster-user" required placeholder="e.g., root@pam">
                        </div>
                        <div class="form-group">
                            <label for="cluster-password">Password *</label>
                            <input type="password" id="cluster-password" placeholder="••••••••">
                            <small id="password-hint" style="display: none;">Leave blank to keep existing password</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Deployment Options</h4>
                    <div class="toggles-grid">
                        <div class="toggle-group">
                            <div class="toggle-switch">
                                <input type="checkbox" id="allow-vm-deployment" checked>
                                <label for="allow-vm-deployment" class="toggle-label"></label>
                            </div>
                            <div class="toggle-info">
                                <strong>Allow VM Deployment</strong>
                                <p>Enable creating and deploying VMs to this cluster</p>
                            </div>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-switch">
                                <input type="checkbox" id="allow-template-sync" checked>
                                <label for="allow-template-sync" class="toggle-label"></label>
                            </div>
                            <div class="toggle-info">
                                <strong>Template Synchronization</strong>
                                <p>Sync templates from this cluster to the database</p>
                            </div>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-switch">
                                <input type="checkbox" id="allow-iso-sync" checked>
                                <label for="allow-iso-sync" class="toggle-label"></label>
                            </div>
                            <div class="toggle-info">
                                <strong>ISO Synchronization</strong>
                                <p>Sync ISO images from this cluster</p>
                            </div>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-switch">
                                <input type="checkbox" id="auto-shutdown-enabled">
                                <label for="auto-shutdown-enabled" class="toggle-label"></label>
                            </div>
                            <div class="toggle-info">
                                <strong>Auto-Shutdown Monitoring</strong>
                                <p>Monitor and auto-shutdown idle VMs on this cluster</p>
                            </div>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-switch">
                                <input type="checkbox" id="is-active" checked>
                                <label for="is-active" class="toggle-label"></label>
                            </div>
                            <div class="toggle-info">
                                <strong>Active Cluster</strong>
                                <p>Enable/disable this cluster</p>
                            </div>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-switch">
                                <input type="checkbox" id="is-default">
                                <label for="is-default" class="toggle-label"></label>
                            </div>
                            <div class="toggle-info">
                                <strong>Default Cluster</strong>
                                <p>Use as default for new users and deployments</p>
                            </div>
                        </div>
                        
                        <div class="toggle-group">
                            <div class="toggle-switch">
                                <input type="checkbox" id="verify-ssl">
                                <label for="verify-ssl" class="toggle-label"></label>
                            </div>
                            <div class="toggle-info">
                                <strong>Verify SSL Certificate</strong>
                                <p>Enable for production environments with valid certs</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Advanced Settings</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="priority">Priority (0-100)</label>
                            <input type="number" id="priority" value="50" min="0" max="100">
                            <small>Higher priority clusters are preferred for deployment</small>
                        </div>
                        <div class="form-group">
                            <label for="default-storage">Default Storage</label>
                            <div class="input-with-button">
                                <select id="default-storage" class="storage-select">
                                    <option value="">-- Select Storage --</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="loadStorages()" title="Load available storages from cluster">
                                    Load
                                </button>
                            </div>
                            <small>Storage pool for VM disks (optional)</small>
                        </div>
                        <div class="form-group form-group-full">
                            <label for="template-storage">Template Storage</label>
                            <div class="input-with-button">
                                <select id="template-storage" class="storage-select">
                                    <option value="">-- Select Storage --</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="loadStorages()" title="Load available storages from cluster">
                                    Load
                                </button>
                            </div>
                            <small>Storage for template exports (optional)</small>
                        </div>
                        <div class="form-group form-group-full">
                            <label for="iso-storage">ISO Storage</label>
                            <div class="input-with-button">
                                <select id="iso-storage" class="storage-select">
                                    <option value="">-- Select Storage (scans all if empty) --</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="loadStorages()" title="Load available storages from cluster">
                                    Load
                                </button>
                            </div>
                            <small>Storage pool to scan for ISO images (optional - scans all ISO storages if empty)</small>
                        </div>
                        <div class="form-group form-group-full">
                            <label for="description">Description</label>
                            <textarea id="description" rows="3" placeholder="Optional notes about this cluster"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-test" onclick="testConnection()">
                        Test Connection
                    </button>
                    <div style="flex: 1;"></div>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        Save Cluster
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
* {
    box-sizing: border-box;
}

.admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 30px;
}

.page-title {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #1e293b;
}

.page-description {
    color: #64748b;
    font-size: 15px;
    margin-bottom: 30px;
}

.settings-section {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 25px;
}

.section-title {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 6px;
    color: #334155;
}

.section-description {
    color: #64748b;
    font-size: 14px;
    line-height: 1.6;
}

.clusters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.cluster-card {
    background: #667eea;
    border-radius: 12px;
    padding: 24px;
    color: white;
    position: relative;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
}

.cluster-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.cluster-card.inactive {
    background: #94a3b8;
    opacity: 0.7;
}

.cluster-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.cluster-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
}

.cluster-host {
    font-size: 13px;
    opacity: 0.9;
    font-family: 'Courier New', monospace;
}

.cluster-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 16px;
}

.badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.badge.badge-default {
    background: rgba(255, 215, 0, 0.9);
    color: #1e293b;
}

.cluster-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.stat {
    text-align: center;
    padding: 10px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 8px;
}

.stat-label {
    font-size: 11px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 16px;
    font-weight: 600;
    margin-top: 4px;
}

.cluster-actions {
    display: flex;
    gap: 8px;
}

.btn-card {
    flex: 1;
    padding: 10px 16px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.btn-card:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
}

.btn-card.btn-danger {
    background: rgba(239, 68, 68, 0.8);
    border-color: rgba(239, 68, 68, 0.9);
}

.btn-card.btn-danger:hover {
    background: rgba(220, 38, 38, 0.9);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
}

.empty-state i {
    font-size: 64px;
    opacity: 0.3;
    margin-bottom: 20px;
}

.empty-state h3 {
    font-size: 20px;
    margin-bottom: 8px;
    color: #475569;
}

.empty-state p {
    margin-bottom: 24px;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    overflow-y: auto;
    padding: 20px;
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 16px;
    width: 100%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-large {
    max-width: 900px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 30px;
    border-bottom: 2px solid #f1f5f9;
}

.modal-header h3 {
    font-size: 22px;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 32px;
    color: #94a3b8;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s;
}

.modal-close:hover {
    background: #f1f5f9;
    color: #64748b;
}

.modal-body {
    padding: 30px;
}

.form-section {
    margin-bottom: 32px;
}

.form-section:last-child {
    margin-bottom: 0;
}

.form-section h4 {
    font-size: 16px;
    font-weight: 600;
    color: #334155;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #f1f5f9;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    color: #475569;
    margin-bottom: 6px;
    font-size: 13px;
}

.form-group input,
.form-group textarea {
    padding: 10px 14px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s;
    font-family: inherit;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group small {
    margin-top: 4px;
    font-size: 12px;
    color: #64748b;
}

.form-group-full {
    grid-column: 1 / -1;
}

.toggles-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.toggle-group {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
    transition: all 0.2s;
}

.toggle-group:hover {
    border-color: #cbd5e1;
    background: #f1f5f9;
}

.toggle-switch {
    flex-shrink: 0;
}

.toggle-switch input[type="checkbox"] {
    display: none;
}

.toggle-label {
    display: block;
    width: 44px;
    height: 24px;
    background: #cbd5e1;
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    transition: background 0.3s;
}

.toggle-label::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    background: white;
    border-radius: 50%;
    top: 3px;
    left: 3px;
    transition: transform 0.3s;
}

.toggle-switch input:checked + .toggle-label {
    background: #667eea;
}

.toggle-switch input:checked + .toggle-label::after {
    transform: translateX(20px);
}

.toggle-info {
    flex: 1;
}

.toggle-info strong {
    display: block;
    font-size: 14px;
    color: #334155;
    margin-bottom: 2px;
}

.toggle-info p {
    font-size: 12px;
    color: #64748b;
    margin: 0;
    line-height: 1.4;
}

.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 2px solid #f1f5f9;
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary {
    background: #f1f5f9;
    color: #475569;
}

.btn-secondary:hover {
    background: #e2e8f0;
}

.btn-test {
    background: #10b981;
    color: white;
}

.btn-test:hover {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.alert {
    padding: 16px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert i {
    font-size: 20px;
}

.alert-success {
    background: #dcfce7;
    color: #166534;
    border: 2px solid #bbf7d0;
}

.alert-error {
    background: #fee2e2;
    color: #991b1b;
    border: 2px solid #fecaca;
}

.alert-info {
    background: #dbeafe;
    color: #1e40af;
    border: 2px solid #bfdbfe;
}

/* Loading spinner */
.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
let clusters = [];
let editingCluster = null;

// Load clusters from database
async function loadClusters() {
    try {
        const resp = await fetch('/api/cluster-config');
        const data = await resp.json();
        if (data.ok) {
            clusters = data.clusters;
            renderClusters();
        } else {
            showAlert('Failed to load clusters: ' + data.error, 'error');
        }
    } catch (e) {
        console.error('Failed to load clusters:', e);
        showAlert('Failed to load cluster configuration', 'error');
    }
}

function renderClusters() {
    const container = document.getElementById('clusters-list');
    const emptyState = document.getElementById('empty-state');
    
    if (clusters.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    container.style.display = 'grid';
    emptyState.style.display = 'none';
    container.innerHTML = '';
    
    clusters.forEach(cluster => {
        const card = document.createElement('div');
        card.className = `cluster-card ${!cluster.is_active ? 'inactive' : ''}`;
        
        // Build badges
        let badges = '';
        if (cluster.is_default) badges += '<span class="badge badge-default">Default</span>';
        if (!cluster.is_active) badges += '<span class="badge">Inactive</span>';
        if (cluster.allow_vm_deployment) badges += '<span class="badge">Deployable</span>';
        if (cluster.auto_shutdown_enabled) badges += '<span class="badge">Auto-Shutdown</span>';
        
        card.innerHTML = `
            <div class="cluster-header">
                <div>
                    <div class="cluster-title">${escapeHtml(cluster.name)}</div>
                    <div class="cluster-host">${escapeHtml(cluster.host)}:${cluster.port}</div>
                </div>
            </div>
            ${badges ? `<div class="cluster-badges">${badges}</div>` : ''}
            <div class="cluster-stats">
                <div class="stat">
                    <div class="stat-label">Priority</div>
                    <div class="stat-value">${cluster.priority}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Templates</div>
                    <div class="stat-value">${cluster.allow_template_sync ? '✓' : '✗'}</div>
                </div>
                <div class="stat">
                    <div class="stat-label">ISO Sync</div>
                    <div class="stat-value">${cluster.allow_iso_sync ? '✓' : '✗'}</div>
                </div>
            </div>
            <div class="cluster-actions">
                <button class="btn-card" onclick="editCluster(${cluster.db_id})">
                    Edit
                </button>
                <button class="btn-card btn-danger" onclick="deleteCluster(${cluster.db_id}, '${escapeHtml(cluster.name)}')">
                    Delete
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showAddClusterModal() {
    editingCluster = null;
    document.getElementById('modal-title').textContent = 'Add Cluster';
    document.getElementById('cluster-form').reset();
    document.getElementById('cluster-db-id').value = '';
    document.getElementById('cluster-id').disabled = false;
    document.getElementById('password-hint').style.display = 'none';
    document.getElementById('cluster-password').required = true;
    
    // Set defaults
    document.getElementById('cluster-port').value = '8006';
    document.getElementById('priority').value = '50';
    document.getElementById('allow-vm-deployment').checked = true;
    document.getElementById('allow-template-sync').checked = true;
    document.getElementById('allow-iso-sync').checked = true;
    document.getElementById('is-active').checked = true;
    
    showModal();
}

function editCluster(dbId) {
    const cluster = clusters.find(c => c.db_id === dbId);
    if (!cluster) return;
    
    editingCluster = cluster;
    document.getElementById('modal-title').textContent = 'Edit Cluster';
    document.getElementById('cluster-db-id').value = cluster.db_id;
    document.getElementById('cluster-id').value = cluster.id;
    document.getElementById('cluster-id').disabled = true; // Don't allow changing ID
    document.getElementById('cluster-name').value = cluster.name;
    document.getElementById('cluster-host').value = cluster.host;
    document.getElementById('cluster-port').value = cluster.port || 8006;
    document.getElementById('cluster-user').value = cluster.user;
    document.getElementById('cluster-password').value = ''; // Don't show password
    document.getElementById('cluster-password').required = false;
    document.getElementById('password-hint').style.display = 'block';
    document.getElementById('verify-ssl').checked = cluster.verify_ssl || false;
    document.getElementById('is-active').checked = cluster.is_active !== false;
    document.getElementById('is-default').checked = cluster.is_default || false;
    document.getElementById('allow-vm-deployment').checked = cluster.allow_vm_deployment !== false;
    document.getElementById('allow-template-sync').checked = cluster.allow_template_sync !== false;
    document.getElementById('allow-iso-sync').checked = cluster.allow_iso_sync !== false;
    document.getElementById('auto-shutdown-enabled').checked = cluster.auto_shutdown_enabled || false;
    document.getElementById('priority').value = cluster.priority || 50;
    document.getElementById('default-storage').value = cluster.default_storage || '';
    document.getElementById('template-storage').value = cluster.template_storage || '';
    document.getElementById('iso-storage').value = cluster.iso_storage || '';
    document.getElementById('description').value = cluster.description || '';
    
    showModal();
}

async function loadStorages() {
    const dbId = document.getElementById('cluster-db-id').value;
    const clusterHost = document.getElementById('cluster-host').value;
    const clusterUser = document.getElementById('cluster-user').value;
    const clusterPassword = document.getElementById('cluster-password').value;
    
    // Check if we have connection details
    if (!clusterHost || !clusterUser) {
        showAlert('Please fill in host and user fields first', 'warning');
        return;
    }
    
    // For new clusters, we need password. For edit, password is optional
    if (!dbId && !clusterPassword) {
        showAlert('Please enter password to test connection', 'warning');
        return;
    }
    
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = 'Loading...';
    
    try {
        let url;
        if (dbId) {
            // Editing existing cluster - use stored credentials
            url = `/api/clusters/${dbId}/storages`;
        } else {
            // New cluster - need to test connection first
            // We'll create a temporary test using the test connection endpoint
            showAlert('Please save the cluster first, then edit it to load storages', 'info');
            return;
        }
        
        const resp = await fetch(url);
        const data = await resp.json();
        
        if (data.ok) {
            // Populate all three dropdowns
            const defaultSelect = document.getElementById('default-storage');
            const templateSelect = document.getElementById('template-storage');
            const isoSelect = document.getElementById('iso-storage');
            
            // Save current selections
            const currentDefault = defaultSelect.value;
            const currentTemplate = templateSelect.value;
            const currentIso = isoSelect.value;
            
            // Clear and repopulate
            [defaultSelect, templateSelect].forEach(select => {
                // Keep first option
                select.innerHTML = '<option value="">-- Select Storage --</option>';
                
                data.storages.forEach(storage => {
                    const option = document.createElement('option');
                    option.value = storage.storage;
                    option.textContent = `${storage.storage} (${storage.type})`;
                    if (!storage.active) {
                        option.textContent += ' [inactive]';
                        option.disabled = true;
                    }
                    select.appendChild(option);
                });
            });
            
            // ISO storage dropdown - filter for storages with 'iso' content
            isoSelect.innerHTML = '<option value="">-- Select Storage (scans all if empty) --</option>';
            data.storages.forEach(storage => {
                // Only show storages that support ISO content
                const contentTypes = storage.content ? storage.content.split(',') : [];
                if (contentTypes.includes('iso')) {
                    const option = document.createElement('option');
                    option.value = storage.storage;
                    option.textContent = `${storage.storage} (${storage.type})`;
                    if (!storage.active) {
                        option.textContent += ' [inactive]';
                        option.disabled = true;
                    }
                    isoSelect.appendChild(option);
                }
            });
            
            // Restore selections if they still exist
            if (currentDefault) defaultSelect.value = currentDefault;
            if (currentTemplate) templateSelect.value = currentTemplate;
            if (currentIso) isoSelect.value = currentIso;
            
            showAlert(`Loaded ${data.storages.length} storage(s) from cluster`, 'success');
        } else {
            showAlert(data.error, 'error');
        }
    } catch (e) {
        console.error('Failed to load storages:', e);
        showAlert('Failed to load storages: ' + e.message, 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
}

async function saveCluster(event) {
    event.preventDefault();
    
    const dbId = document.getElementById('cluster-db-id').value;
    const isEdit = !!dbId;
    
    const clusterData = {
        cluster_id: document.getElementById('cluster-id').value,
        name: document.getElementById('cluster-name').value,
        host: document.getElementById('cluster-host').value,
        port: parseInt(document.getElementById('cluster-port').value),
        user: document.getElementById('cluster-user').value,
        verify_ssl: document.getElementById('verify-ssl').checked,
        is_active: document.getElementById('is-active').checked,
        is_default: document.getElementById('is-default').checked,
        allow_vm_deployment: document.getElementById('allow-vm-deployment').checked,
        allow_template_sync: document.getElementById('allow-template-sync').checked,
        allow_iso_sync: document.getElementById('allow-iso-sync').checked,
        auto_shutdown_enabled: document.getElementById('auto-shutdown-enabled').checked,
        priority: parseInt(document.getElementById('priority').value),
        default_storage: document.getElementById('default-storage').value || null,
        template_storage: document.getElementById('template-storage').value || null,
        iso_storage: document.getElementById('iso-storage').value || null,
        description: document.getElementById('description').value || null
    };
    
    const password = document.getElementById('cluster-password').value;
    if (password || !isEdit) {
        clusterData.password = password;
    }
    
    try {
        const url = isEdit ? `/api/cluster-config/${dbId}` : '/api/cluster-config';
        const method = isEdit ? 'PUT' : 'POST';
        
        const resp = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(clusterData)
        });
        
        const data = await resp.json();
        if (data.ok) {
            showAlert(data.message, 'success');
            closeModal();
            await loadClusters();
        } else {
            showAlert(data.error, 'error');
        }
    } catch (e) {
        console.error('Save failed:', e);
        showAlert('Failed to save cluster: ' + e.message, 'error');
    }
}

async function deleteCluster(dbId, name) {
    if (!confirm(`Are you sure you want to delete cluster "${name}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const resp = await fetch(`/api/cluster-config/${dbId}`, {
            method: 'DELETE'
        });
        
        const data = await resp.json();
        if (data.ok) {
            showAlert(data.message, 'success');
            await loadClusters();
        } else {
            showAlert(data.error, 'error');
        }
    } catch (e) {
        console.error('Delete failed:', e);
        showAlert('Failed to delete cluster: ' + e.message, 'error');
    }
}

async function testConnection() {
    const dbId = document.getElementById('cluster-db-id').value;
    
    if (!dbId) {
        alert('Please save the cluster first before testing connection');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Testing...';
    
    try {
        const resp = await fetch(`/api/cluster-config/${dbId}/test`, {
            method: 'POST'
        });
        
        const data = await resp.json();
        if (data.ok) {
            alert(`✅ Connection Successful!\n\nProxmox Version: ${data.version}\nNodes: ${data.nodes}\nNode Names: ${data.node_names.join(', ')}`);
        } else {
            alert(`❌ Connection Failed\n\n${data.error}`);
        }
    } catch (e) {
        console.error('Test failed:', e);
        alert(`❌ Connection Test Failed\n\n${e.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function showModal() {
    document.getElementById('cluster-modal').classList.add('active');
}

function closeModal() {
    document.getElementById('cluster-modal').classList.remove('active');
}

// Close modal on outside click
document.getElementById('cluster-modal').addEventListener('click', (e) => {
    if (e.target.id === 'cluster-modal') {
        closeModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeModal();
    }
});

function showAlert(message, type) {
    const existing = document.querySelector('.alert');
    if (existing) existing.remove();
    
    const iconMap = {
        success: 'circle-check-filled',
        error: 'alert-triangle-filled',
        info: 'info-circle-filled'
    };
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <span>${message}</span>
    `;
    
    const section = document.querySelector('.settings-section');
    section.insertBefore(alert, section.firstChild);
    
    if (type === 'success') {
        setTimeout(() => alert.remove(), 5000);
    }
}

// Load on page load
window.addEventListener('DOMContentLoaded', loadClusters);
</script>
{% endblock %}
