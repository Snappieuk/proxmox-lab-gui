{% extends "base.html" %}

{% block title %}Maintenance - Admin{% endblock %}

{% block content %}
<div class="admin-maintenance-container">
    <div class="page-header">
        <div>
            <h1><i class="ti ti-tools"></i> Maintenance & Cleanup</h1>
            <p class="page-subtitle">Manage database assignments and clean up duplicates</p>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="content-card">
        <h2 style="margin-top: 0;">Assignment Statistics</h2>
        <div id="stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0;">
            <div class="stat-box">
                <div class="stat-value" id="stat-total">-</div>
                <div class="stat-label">Total VM Assignments</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="stat-in-classes">-</div>
                <div class="stat-label">in Classes</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="stat-with-users">-</div>
                <div class="stat-label">Assigned to Users</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="stat-duplicates">-</div>
                <div class="stat-label">VMs with Multiple Users</div>
            </div>
        </div>
        <button onclick="refreshStats()" class="btn-secondary" style="margin-top: 1rem;">
            <i class="ti ti-refresh"></i> Refresh Stats
        </button>
    </div>

    <!-- Duplicate Detection Section -->
    <div class="content-card" style="margin-top: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div>
                <h2 style="margin: 0;">Duplicate Assignments</h2>
                <p style="color: #666; font-size: 0.9rem; margin: 0.5rem 0 0 0;">Same VM assigned to multiple different users in same class (should be 1 user per VM)</p>
            </div>
            <button onclick="loadDuplicates()" class="btn-secondary">
                <i class="ti ti-list"></i> Load List
            </button>
        </div>
        
        <div id="duplicates-list" style="margin: 1rem 0; min-height: 100px;">
            <p style="color: #999;">Click "Load List" to detect duplicates</p>
        </div>
    </div>

    <!-- VM Recovery Section -->
    <div class="content-card" style="margin-top: 2rem; border: 2px solid #ffc107; background: #fffbf0;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h2 style="margin: 0; color: #856404;"><i class="ti ti-alert-circle"></i> Recover Missing Class VMs</h2>
                <p style="color: #666; font-size: 0.9rem; margin: 0.5rem 0 0 0;">
                    If you accidentally deleted class VM assignments, Proxmox still has the VMs. This will re-scan Proxmox and recover them.
                </p>
                <p style="color: #666; font-size: 0.85rem; margin: 0.5rem 0 0 0;">
                    <strong>Pattern:</strong> VMs with VMID starting with class ID (e.g., class 5 ‚Üí VMID 50001, 50002, etc)
                </p>
            </div>
        </div>
        <button onclick="testMaintenanceAPI()" class="btn-secondary" style="margin-top: 1rem; margin-right: 0.5rem;">
            <i class="ti ti-alert-triangle"></i> Test API Connection
        </button>
        <button onclick="showAllVMs()" class="btn-secondary" style="margin-top: 1rem; margin-right: 0.5rem;">
            <i class="ti ti-list"></i> Show All VMs
        </button>
        <button onclick="recoverVMsFromProxmox()" class="btn-primary" style="margin-top: 1rem;">
            <i class="ti ti-refresh"></i> Scan & Recover VMs from Proxmox
        </button>
        <span id="recovery-status" class="ms-2"></span>
    </div>

    <!-- Manual Recovery Section -->
    <div class="content-card" style="margin-top: 2rem; border: 2px solid #17a2b8; background: #f0f8ff;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h2 style="margin: 0; color: #0c5460;"><i class="ti ti-hand-move"></i> Manual VM Recovery</h2>
                <p style="color: #0c5460; font-size: 0.9rem; margin: 0.5rem 0 0 0;">
                    Manually select VMs from Proxmox and add them to a class
                </p>
            </div>
        </div>
        
        <div style="margin-top: 1.5rem;">
            <label for="manual-class-select" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Select Class:</label>
            <select id="manual-class-select" class="form-control" style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 1rem;">
                <option value="">-- Choose a class --</option>
            </select>
            
            <div style="margin-bottom: 1rem;">
                <button onclick="loadVMsForManualRecovery()" class="btn-secondary" style="margin-top: 0;">
                    <i class="ti ti-refresh"></i> Load Available VMs
                </button>
            </div>
            
            <div id="manual-vm-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; padding: 1rem; background: white; margin-bottom: 1rem; display: none;">
                <p style="color: #999;">Click "Load Available VMs" to see the list</p>
            </div>
            
            <button onclick="addSelectedVMsToClass()" class="btn-primary" style="margin-top: 0;">
                <i class="ti ti-check"></i> Add Selected VMs to Class
            </button>
            <span id="manual-recovery-status" class="ms-2"></span>
        </div>
    </div>
</div>

<style>
.admin-maintenance-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.stat-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.assignment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    border-left: 4px solid #667eea;
}

.assignment-info {
    flex: 1;
}

.assignment-id {
    font-weight: 600;
    color: #333;
}

.assignment-details {
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.25rem;
}

.btn-delete-item {
    background: #dc3545;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.btn-delete-item:hover {
    background: #c82333;
}

.duplicate-group {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
}

.duplicate-group-header {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #856404;
}

.duplicate-group-item {
    background: white;
    padding: 0.75rem;
    margin-top: 0.5rem;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-primary, .btn-secondary, .btn-danger {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.95rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.content-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

<script>
async function refreshStats() {
    try {
        const resp = await fetch('/api/admin/maintenance/assignments/stats');
        const data = await resp.json();
        
        if (!data.ok) {
            alert('Failed to load stats: ' + (data.error || 'Unknown error'));
            return;
        }
        
        const stats = data.stats;
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-in-classes').textContent = stats.in_classes;
        document.getElementById('stat-with-users').textContent = stats.assigned_to_users;
        document.getElementById('stat-duplicates').textContent = stats.duplicate_groups;
    } catch (e) {
        console.error('Error:', e);
        alert('Failed to load stats');
    }
}

async function loadDuplicates() {
    try {
        const resp = await fetch('/api/admin/maintenance/assignments/duplicates');
        const data = await resp.json();
        
        if (!data.ok) {
            alert('Failed to load duplicates: ' + (data.error || 'Unknown error'));
            return;
        }
        
        const container = document.getElementById('duplicates-list');
        const duplicates = data.duplicates;
        
        if (duplicates.length === 0) {
            container.innerHTML = '<p style="color: #666; font-style: italic;">No duplicate assignments found!</p>';
            return;
        }
        
        container.innerHTML = duplicates.map(group => `
            <div class="duplicate-group">
                <div class="duplicate-group-header">
                    VM ${group.vmid} in ${group.class_name} (${group.count} copies)
                </div>
                ${group.assignments.map((assign, idx) => `
                    <div class="duplicate-group-item">
                        <div>
                            <strong>#${assign.id}</strong> - ${assign.username} (${assign.status})
                        </div>
                        <button class="btn-delete-item" onclick="deleteAssignment(${assign.id})">
                            <i class="ti ti-trash"></i> Delete
                        </button>
                    </div>
                `).join('')}
            </div>
        `).join('');
    } catch (e) {
        console.error('Error:', e);
        alert('Failed to load duplicate assignments');
    }
}

async function deleteAssignment(id) {
    if (!confirm('Delete assignment #' + id + '? This cannot be undone.')) {
        return;
    }
    
    try {
        const resp = await fetch(`/api/admin/maintenance/assignments/delete/${id}`, { method: 'DELETE' });
        const data = await resp.json();
        
        if (!data.ok) {
            alert('Failed to delete: ' + (data.error || 'Unknown error'));
            return;
        }
        
        alert('‚úì Assignment deleted');
        loadDuplicates();
        refreshStats();
    } catch (e) {
        console.error('Error:', e);
        alert('Failed to delete assignment');
    }
}

async function testMaintenanceAPI() {
    try {
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-secondary">Testing...</span>';
        
        const resp = await fetch('/api/admin/maintenance/health');
        const data = await resp.json();
        
        if (data.ok) {
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-success">API OK</span>';
            alert('‚úì Maintenance API is working\n\n' + data.status);
        } else {
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Error</span>';
            alert('API Error: ' + (data.error || 'Unknown'));
        }
    } catch (e) {
        console.error('Error:', e);
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Error: ' + e.message + '</span>';
        alert('Test failed: ' + e.message);
    }
}

async function showAllVMs() {
    try {
        const resp = await fetch('/api/admin/maintenance/recover-vms/list-all-vms');
        const data = await resp.json();
        
        if (!data.ok) {
            alert('Failed to load VMs: ' + data.error);
            return;
        }
        
        const vms = data.vms;
        let msg = `Total VMs in Proxmox: ${vms.length}\n\n`;
        msg += 'VMID | Name | Status | In DB?\n';
        msg += '-----+----+-----+---\n';
        
        vms.forEach(vm => {
            const inDb = vm.in_db ? 'YES' : 'NO';
            msg += `${vm.vmid.toString().padEnd(5)} | ${vm.name.substring(0, 20).padEnd(20)} | ${vm.status.padEnd(7)} | ${inDb}\n`;
        });
        
        console.log('All VMs:', vms);
        console.log('\n' + msg);
        
        alert(msg + '\n\nFull list logged to browser console (F12)');
    } catch (e) {
        console.error('Error:', e);
        alert('Failed to load VMs: ' + e.message);
    }
}

async function scanRecoverableVMs() {
    try {
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-secondary">Scanning...</span>';
        
        const resp = await fetch('/api/admin/maintenance/recover-vms/scan');
        
        // Check HTTP status
        if (!resp.ok) {
            console.error('HTTP Error:', resp.status, resp.statusText);
            const text = await resp.text();
            console.error('Response:', text.substring(0, 500));
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">HTTP ' + resp.status + '</span>';
            alert('Scan failed: HTTP ' + resp.status + '\n\n' + text.substring(0, 200));
            return null;
        }
        
        // Try to parse response
        let data;
        try {
            const text = await resp.text();
            data = JSON.parse(text);
        } catch (e) {
            console.error('JSON Parse Error:', e);
            console.error('Response was:', text.substring(0, 500));
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Parse Error</span>';
            alert('Scan failed: Invalid JSON response\n\nCheck browser console for details');
            return null;
        }
        
        if (!data.ok) {
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Scan failed</span>';
            alert('Scan failed: ' + (data.error || 'Unknown error'));
            return null;
        }
        
        return data;
    } catch (e) {
        console.error('Error:', e);
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Error: ' + e.message + '</span>';
        alert('Scan failed: ' + e.message + '\n\nCheck browser console for details');
        return null;
    }
}

async function recoverVMsFromProxmox() {
    try {
        // First scan
        const scanResult = await scanRecoverableVMs();
        if (!scanResult) return;
        
        const total = scanResult.total_recoverable;
        
        console.log('Scan result:', scanResult);
        console.log('Total recoverable:', total);
        console.log('Recoverable by class:', scanResult.recoverable);
        
        if (total === 0) {
            alert('‚úì No recoverable VMs found\n\nThis could mean:\n- All class VMs are already in the database\n- No VMs match the class ID pattern (class 5 ‚Üí VMID 50xxx)\n- Check browser console for debug details');
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-success">No VMs to recover</span>';
            return;
        }
        
        // Show preview
        let preview = `Found ${total} VMs to recover:\n\n`;
        for (const [classId, data] of Object.entries(scanResult.recoverable)) {
            preview += `Class ${classId} (${data.class_name}): ${data.count} VMs\n`;
            data.vms.forEach(vm => {
                preview += `  ‚Ä¢ VMID ${vm.vmid} (${vm.name})\n`;
            });
        }
        preview += '\nProceed with recovery?';
        
        if (!confirm(preview)) {
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-secondary">Cancelled</span>';
            return;
        }
        
        // Perform recovery
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-secondary">Recovering...</span>';
        
        const resp = await fetch('/api/admin/maintenance/recover-vms/recover', { method: 'POST' });
        const result = await resp.json();
        
        if (!result.ok) {
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Failed</span>';
            alert('Recovery failed: ' + (result.error || 'Unknown error'));
            return;
        }
        
        document.getElementById('recovery-status').innerHTML = `<span class="badge bg-success">Recovered ${result.recovered} VMs</span>`;
        alert(`‚úì Recovery complete!\n\nRestored ${result.recovered} VMs to their classes`);
        
        refreshStats();
    } catch (e) {
        console.error('Error:', e);
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Error</span>';
        alert('Recovery failed: ' + e.message + '\n\nCheck browser console for details');
    }
}

// Populate class dropdown on page load
async function loadClassesForManualRecovery() {
    try {
        const response = await fetch('/api/classes');
        const data = await response.json();

        if (!data.ok) {
            console.error('Failed to load classes:', data.error);
            return;
        }

        const select = document.getElementById('manual-class-select');
        select.innerHTML = '<option value="">-- Choose a class --</option>';

        if (data.classes && data.classes.length > 0) {
            data.classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = `${cls.name} (ID: ${cls.id})`;
                select.appendChild(option);
            });
        } else {
            select.innerHTML += '<option disabled>No classes found</option>';
        }
    } catch (error) {
        console.error('Error loading classes:', error);
    }
}

// Load VMs for manual recovery
async function loadVMsForManualRecovery() {
    const classId = document.getElementById('manual-class-select').value;
    
    if (!classId) {
        alert('Please select a class first');
        return;
    }

    const button = event.target;
    button.disabled = true;
    button.textContent = '‚è≥ Loading...';

    try {
        const response = await fetch('/api/admin/maintenance/recover-vms/list-all-vms');
        const data = await response.json();

        if (!data.ok) {
            alert(`Error: ${data.error}`);
            return;
        }

        const vmList = document.getElementById('manual-vm-list');
        vmList.style.display = 'block';
        vmList.innerHTML = '';

        if (!data.vms || data.vms.length === 0) {
            vmList.innerHTML = '<p style="color: #999;">No VMs found in Proxmox</p>';
            return;
        }

        // Filter to only unassigned VMs
        const unassignedVMs = data.vms.filter(vm => !vm.assigned);

        if (unassignedVMs.length === 0) {
            vmList.innerHTML = '<p style="color: #999;">All VMs are already assigned to classes</p>';
            return;
        }

        // Create checkboxes for each unassigned VM
        unassignedVMs.forEach(vm => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.style.padding = '0.5rem';
            label.style.borderBottom = '1px solid #eee';
            label.style.cursor = 'pointer';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = vm.vmid;
            checkbox.className = 'vm-checkbox';
            checkbox.style.marginRight = '0.5rem';

            const vmInfo = document.createElement('span');
            vmInfo.textContent = `VMID ${vm.vmid}: ${vm.name} (${vm.type}, on ${vm.node})`;
            vmInfo.style.fontSize = '0.9rem';

            label.appendChild(checkbox);
            label.appendChild(vmInfo);
            vmList.appendChild(label);
        });

    } catch (error) {
        console.error('Error loading VMs:', error);
        document.getElementById('manual-vm-list').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
    } finally {
        button.disabled = false;
        button.textContent = 'üîÑ Load Available VMs';
    }
}

// Add selected VMs to class
async function addSelectedVMsToClass() {
    const classId = document.getElementById('manual-class-select').value;
    const checkboxes = document.querySelectorAll('.vm-checkbox:checked');
    const vmids = Array.from(checkboxes).map(cb => parseInt(cb.value));

    if (!classId) {
        alert('Please select a class');
        return;
    }

    if (vmids.length === 0) {
        alert('Please select at least one VM');
        return;
    }

    const button = event.target;
    button.disabled = true;
    const status = document.getElementById('manual-recovery-status');
    status.textContent = '‚è≥ Adding...';
    status.style.color = 'blue';

    try {
        const response = await fetch('/api/admin/maintenance/recover-vms/manually-add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                class_id: parseInt(classId),
                vmids: vmids
            })
        });

        const data = await response.json();

        if (!data.ok) {
            status.textContent = `‚ùå ${data.error}`;
            status.style.color = 'red';
            return;
        }

        const message = `‚úÖ Added ${data.added} VM(s)`;
        const skippedMsg = data.skipped > 0 ? ` (${data.skipped} skipped)` : '';
        status.textContent = message + skippedMsg;
        status.style.color = 'green';

        // Clear selection and refresh stats
        document.getElementById('manual-vm-list').innerHTML = '';
        document.getElementById('manual-vm-list').style.display = 'none';
        document.querySelectorAll('.vm-checkbox').forEach(cb => cb.checked = false);
        
        setTimeout(() => {
            refreshStats();
        }, 1000);

    } catch (error) {
        console.error('Error:', error);
        status.textContent = `‚ùå Error: ${error.message}`;
        status.style.color = 'red';
    } finally {
        button.disabled = false;
    }
}

// Load on page load
refreshStats();
loadClassesForManualRecovery();
</script>
{% endblock %}
