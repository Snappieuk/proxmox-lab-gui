{% extends "base.html" %}

{% block title %}Maintenance - Admin{% endblock %}

{% block content %}
<div class="admin-maintenance-container">
    <div class="page-header">
        <div>
            <h1><i class="ti ti-tools"></i> Maintenance & Cleanup</h1>
            <p class="page-subtitle">Manage database assignments and clean up duplicates</p>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="content-card">
        <h2 style="margin-top: 0;">Assignment Statistics</h2>
        <div id="stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0;">
            <div class="stat-box">
                <div class="stat-value" id="stat-total">-</div>
                <div class="stat-label">Total VM Assignments</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="stat-in-classes">-</div>
                <div class="stat-label">in Classes</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="stat-with-users">-</div>
                <div class="stat-label">Assigned to Users</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="stat-duplicates">-</div>
                <div class="stat-label">Duplicate Groups</div>
            </div>
        </div>
        <button onclick="refreshStats()" class="btn-secondary" style="margin-top: 1rem;">
            <i class="ti ti-refresh"></i> Refresh Stats
        </button>
    </div>

    <!-- Duplicate Detection Section -->
    <div class="content-card" style="margin-top: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div>
                <h2 style="margin: 0;">Duplicate Assignments</h2>
                <p style="color: #666; font-size: 0.9rem; margin: 0.5rem 0 0 0;">Same VM assigned multiple times to same class (should be 1 copy per VM)</p>
            </div>
            <button onclick="loadDuplicates()" class="btn-secondary">
                <i class="ti ti-list"></i> Load List
            </button>
        </div>
        
        <div id="duplicates-list" style="margin: 1rem 0; min-height: 100px;">
            <p style="color: #999;">Click "Load List" to detect duplicates</p>
        </div>
    </div>

    <!-- VM Recovery Section -->
    <div class="content-card" style="margin-top: 2rem; border: 2px solid #ffc107; background: #fffbf0;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h2 style="margin: 0; color: #856404;"><i class="ti ti-alert-circle"></i> Recover Missing Class VMs</h2>
                <p style="color: #666; font-size: 0.9rem; margin: 0.5rem 0 0 0;">
                    If you accidentally deleted class VM assignments, Proxmox still has the VMs. This will re-scan Proxmox and recover them.
                </p>
                <p style="color: #666; font-size: 0.85rem; margin: 0.5rem 0 0 0;">
                    <strong>Pattern:</strong> VMs with VMID starting with class ID (e.g., class 5 → VMID 50001, 50002, etc)
                </p>
            </div>
        </div>
        <button onclick="testMaintenanceAPI()" class="btn-secondary" style="margin-top: 1rem; margin-right: 0.5rem;">
            <i class="ti ti-alert-triangle"></i> Test API Connection
        </button>
        <button onclick="recoverVMsFromProxmox()" class="btn-primary" style="margin-top: 1rem;">
            <i class="ti ti-refresh"></i> Scan & Recover VMs from Proxmox
        </button>
        <span id="recovery-status" class="ms-2"></span>
    </div>
</div>

<style>
.admin-maintenance-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.stat-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.assignment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    border-left: 4px solid #667eea;
}

.assignment-info {
    flex: 1;
}

.assignment-id {
    font-weight: 600;
    color: #333;
}

.assignment-details {
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.25rem;
}

.btn-delete-item {
    background: #dc3545;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.btn-delete-item:hover {
    background: #c82333;
}

.duplicate-group {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
}

.duplicate-group-header {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #856404;
}

.duplicate-group-item {
    background: white;
    padding: 0.75rem;
    margin-top: 0.5rem;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-primary, .btn-secondary, .btn-danger {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.95rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.content-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

<script>
async function refreshStats() {
    try {
        const resp = await fetch('/api/admin/maintenance/assignments/stats');
        const data = await resp.json();
        
        if (!data.ok) {
            alert('Failed to load stats: ' + (data.error || 'Unknown error'));
            return;
        }
        
        const stats = data.stats;
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-in-classes').textContent = stats.in_classes;
        document.getElementById('stat-with-users').textContent = stats.assigned_to_users;
        document.getElementById('stat-duplicates').textContent = stats.duplicate_groups;
    } catch (e) {
        console.error('Error:', e);
        alert('Failed to load stats');
    }
}

async function loadDuplicates() {
    try {
        const resp = await fetch('/api/admin/maintenance/assignments/duplicates');
        const data = await resp.json();
        
        if (!data.ok) {
            alert('Failed to load duplicates: ' + (data.error || 'Unknown error'));
            return;
        }
        
        const container = document.getElementById('duplicates-list');
        const duplicates = data.duplicates;
        
        if (duplicates.length === 0) {
            container.innerHTML = '<p style="color: #666; font-style: italic;">No duplicate assignments found!</p>';
            return;
        }
        
        container.innerHTML = duplicates.map(group => `
            <div class="duplicate-group">
                <div class="duplicate-group-header">
                    VM ${group.vmid} in ${group.class_name} (${group.count} copies)
                </div>
                ${group.assignments.map((assign, idx) => `
                    <div class="duplicate-group-item">
                        <div>
                            <strong>#${assign.id}</strong> - ${assign.username} (${assign.status})
                        </div>
                        <button class="btn-delete-item" onclick="deleteAssignment(${assign.id})">
                            <i class="ti ti-trash"></i> Delete
                        </button>
                    </div>
                `).join('')}
            </div>
        `).join('');
    } catch (e) {
        console.error('Error:', e);
        alert('Failed to load duplicate assignments');
    }
}

async function deleteAssignment(id) {
    if (!confirm('Delete assignment #' + id + '? This cannot be undone.')) {
        return;
    }
    
    try {
        const resp = await fetch(`/api/admin/maintenance/assignments/delete/${id}`, { method: 'DELETE' });
        const data = await resp.json();
        
        if (!data.ok) {
            alert('Failed to delete: ' + (data.error || 'Unknown error'));
            return;
        }
        
        alert('✓ Assignment deleted');
        loadDuplicates();
        refreshStats();
    } catch (e) {
        console.error('Error:', e);
        alert('Failed to delete assignment');
    }
}

async function testMaintenanceAPI() {
    try {
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-secondary">Testing...</span>';
        
        const resp = await fetch('/api/admin/maintenance/health');
        const data = await resp.json();
        
        if (data.ok) {
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-success">API OK</span>';
            alert('✓ Maintenance API is working\n\n' + data.status);
        } else {
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Error</span>';
            alert('API Error: ' + (data.error || 'Unknown'));
        }
    } catch (e) {
        console.error('Error:', e);
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Error: ' + e.message + '</span>';
        alert('Test failed: ' + e.message);
    }
}

async function scanRecoverableVMs() {
    try {
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-secondary">Scanning...</span>';
        
        const resp = await fetch('/api/admin/maintenance/recover-vms/scan');
        
        // Check HTTP status
        if (!resp.ok) {
            console.error('HTTP Error:', resp.status, resp.statusText);
            const text = await resp.text();
            console.error('Response:', text.substring(0, 500));
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">HTTP ' + resp.status + '</span>';
            alert('Scan failed: HTTP ' + resp.status + '\n\n' + text.substring(0, 200));
            return null;
        }
        
        // Try to parse response
        let data;
        try {
            const text = await resp.text();
            data = JSON.parse(text);
        } catch (e) {
            console.error('JSON Parse Error:', e);
            console.error('Response was:', text.substring(0, 500));
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Parse Error</span>';
            alert('Scan failed: Invalid JSON response\n\nCheck browser console for details');
            return null;
        }
        
        if (!data.ok) {
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Scan failed</span>';
            alert('Scan failed: ' + (data.error || 'Unknown error'));
            return null;
        }
        
        return data;
    } catch (e) {
        console.error('Error:', e);
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Error: ' + e.message + '</span>';
        alert('Scan failed: ' + e.message + '\n\nCheck browser console for details');
        return null;
    }
}

async function recoverVMsFromProxmox() {
    try {
        // First scan
        const scanResult = await scanRecoverableVMs();
        if (!scanResult) return;
        
        const total = scanResult.total_recoverable;
        
        if (total === 0) {
            alert('✓ No recoverable VMs found - all class VMs are already in the database');
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-success">No VMs to recover</span>';
            return;
        }
        
        // Show preview
        let preview = `Found ${total} VMs to recover:\n\n`;
        for (const [classId, data] of Object.entries(scanResult.recoverable)) {
            preview += `Class ${classId} (${data.class_name}): ${data.count} VMs\n`;
        }
        preview += '\nProceed with recovery?';
        
        if (!confirm(preview)) {
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-secondary">Cancelled</span>';
            return;
        }
        
        // Perform recovery
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-secondary">Recovering...</span>';
        
        const resp = await fetch('/api/admin/maintenance/recover-vms/recover', { method: 'POST' });
        const result = await resp.json();
        
        if (!result.ok) {
            document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Failed</span>';
            alert('Recovery failed: ' + (result.error || 'Unknown error'));
            return;
        }
        
        document.getElementById('recovery-status').innerHTML = `<span class="badge bg-success">Recovered ${result.recovered} VMs</span>`;
        alert(`✓ Recovery complete!\n\nRestored ${result.recovered} VMs to their classes`);
        
        refreshStats();
    } catch (e) {
        console.error('Error:', e);
        document.getElementById('recovery-status').innerHTML = '<span class="badge bg-danger">Error</span>';
        alert('Recovery failed: ' + e.message);
    }
}

// Load on page load
refreshStats();
</script>
{% endblock %}
