{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="bi bi-plus-circle"></i> Create New Class</h1>
        <p class="page-subtitle">Set up a new lab class with a VM template</p>
    </div>
</div>

<div class="form-container">
    <form id="create-class-form" class="form-panel">
        <div class="form-group">
            <label for="class-name">Class Name *</label>
            <input type="text" id="class-name" name="name" required 
                   placeholder="e.g., Introduction to Linux" maxlength="120">
        </div>
        
        <div class="form-group">
            <label for="class-description">Description</label>
            <textarea id="class-description" name="description" rows="3"
                      placeholder="Brief description of this class..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="template-select">Template</label>
            <select id="template-select" name="template_id">
                <option value="">Loading templates...</option>
            </select>
            <small class="form-help">Select a template or choose "None" to create VMs without a template</small>
        </div>
        
        <div class="form-group" id="alter-specs-container" style="display: none;">
            <label>
                <input type="checkbox" id="alter-specs-checkbox" style="width: auto; margin-right: 8px;">
                Alter VM Specs
            </label>
            <small class="form-help">Customize CPU and RAM for VMs created from template</small>
        </div>
        
        <div id="vm-specs-section" style="display: none;">
            <div class="form-group">
                <label for="cpu-cores">CPU Cores per VM</label>
                <input type="number" id="cpu-cores" name="cpu_cores" min="1" max="16" value="2"
                       placeholder="Number of CPU cores">
                <small class="form-help">Number of CPU cores allocated to each VM</small>
            </div>
            
            <div class="form-group">
                <label for="memory-mb">RAM per VM (MB)</label>
                <input type="number" id="memory-mb" name="memory_mb" min="512" max="32768" step="512" value="2048"
                       placeholder="RAM in megabytes">
                <small class="form-help">RAM allocated to each VM (2048 MB = 2 GB)</small>
            </div>
            
            <div class="form-group" id="disk-size-group">
                <label for="disk-size-gb">Disk Size per VM (GB)</label>
                <input type="number" id="disk-size-gb" name="disk_size_gb" min="8" max="500" value="32"
                       placeholder="Disk size in gigabytes">
                <small class="form-help">Disk size for template-less VMs (32 GB default). Ignored when using a template.</small>
            </div>
        </div>
        
        <div class="form-group">
            <label for="pool-size">VM Pool Size</label>
            <input type="number" id="pool-size" name="pool_size" min="0" value="0"
                   placeholder="Number of VMs to pre-create">
            <small class="form-help">VMs can be created later if set to 0</small>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('classes.classes_list') }}" class="btn-secondary">Cancel</a>
            <button type="submit" class="btn-primary">
                <i class="bi bi-check-lg"></i> Create Class
            </button>
        </div>
    </form>
</div>

<style>
.form-container {
    max-width: 700px;
    margin: 2rem auto;
}

.form-panel {
    background: white;
    border: 1px solid #e1dfdd;
    border-radius: 8px;
    padding: 2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #323130;
}

.form-group input[type="text"],
.form-group input[type="number"],
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #8a8886;
    border-radius: 4px;
    font-size: 0.95rem;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #0078d4;
    box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.1);
}

.form-help {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: #605e5c;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e1dfdd;
}

.btn-primary, .btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
    text-decoration: none;
}

.btn-primary {
    background: #0078d4;
    color: white;
    border: none;
}

.btn-primary:hover {
    background: #106ebe;
}

.btn-secondary {
    background: #f3f2f1;
    color: #323130;
    border: 1px solid #8a8886;
}

.btn-secondary:hover {
    background: #e1dfdd;
}
</style>

<script>
// Load templates when page loads
document.addEventListener('DOMContentLoaded', async function() {
    await loadTemplates();
    
    // Handle template selection and checkbox changes
    document.getElementById('template-select').addEventListener('change', function() {
        updateSpecsVisibility();
    });

    document.getElementById('alter-specs-checkbox').addEventListener('change', function() {
        updateSpecsVisibility();
    });
});

async function loadTemplates(usePoll = false) {
    const selectElement = document.getElementById('template-select');
    
    try {
        const url = usePoll ? '/api/classes/templates?poll=true' : '/api/classes/templates';
        const resp = await fetch(url);
        const data = await resp.json();
        
        if (!data.ok) {
            selectElement.innerHTML = '<option value="">Failed to load templates</option>';
            return;
        }
        
        const proxmoxTemplates = data.proxmox_templates || [];
        const registeredTemplates = data.registered_templates || [];
        
        // Create map of registered templates by VMID for quick lookup
        const registeredMap = {};
        registeredTemplates.forEach(t => {
            registeredMap[t.proxmox_vmid] = t.id;
        });
        
        // Store template data for later use
        window.templateData = {
            proxmox: proxmoxTemplates,
            registered: registeredMap
        };
        
        if (proxmoxTemplates.length === 0) {
            selectElement.innerHTML = '<option value="">None (No templates found)</option>';
            // Show message to user
            if (!usePoll) {
                showTemplateMessage('No templates found. Templates may be replicating to nodes...', 'info');
                // Trigger replication and start polling
                await triggerReplicationAndPoll();
            }
        } else {
            selectElement.innerHTML = '<option value="">None</option>' +
                proxmoxTemplates.map(t => {
                    const registered = registeredMap[t.vmid] ? ' âœ“' : '';
                    return `<option value="${t.vmid}" data-name="${t.name}" data-node="${t.node}">${t.name} (VMID: ${t.vmid})${registered}</option>`;
                }).join('');
            hideTemplateMessage();
        }
        
        // Update specs visibility after templates are loaded
        updateSpecsVisibility();
        
    } catch (e) {
        console.error('Failed to load templates:', e);
        selectElement.innerHTML = '<option value="">None</option>';
        // Update specs visibility even on error
        updateSpecsVisibility();
    }
}

async function triggerReplicationAndPoll() {
    showTemplateMessage('Replicating templates to all nodes... This may take a few minutes.', 'loading');
    
    try {
        // Trigger replication in background
        const resp = await fetch('/api/classes/templates/replicate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await resp.json();
        
        if (!data.ok) {
            showTemplateMessage('Failed to start template replication: ' + (data.error || 'Unknown error'), 'error');
            return;
        }
        
        // Start polling for templates (every 5 seconds, max 2 minutes)
        let attempts = 0;
        const maxAttempts = 24; // 24 * 5s = 2 minutes
        const pollInterval = 5000; // 5 seconds
        
        const pollTimer = setInterval(async () => {
            attempts++;
            
            showTemplateMessage(`Checking for templates... (${attempts}/${maxAttempts})`, 'loading');
            
            // Fetch templates with poll mode
            const pollResp = await fetch('/api/classes/templates?poll=false');
            const pollData = await pollResp.json();
            
            if (pollData.ok && pollData.template_count > 0) {
                // Templates found!
                clearInterval(pollTimer);
                showTemplateMessage(`Found ${pollData.template_count} template(s)! Reloading...`, 'success');
                
                setTimeout(async () => {
                    await loadTemplates(false);
                    hideTemplateMessage();
                }, 1000);
            } else if (attempts >= maxAttempts) {
                // Timeout
                clearInterval(pollTimer);
                showTemplateMessage('Template replication is taking longer than expected. Please refresh the page in a few minutes.', 'error');
            }
        }, pollInterval);
        
    } catch (e) {
        console.error('Failed to trigger replication:', e);
        showTemplateMessage('Failed to trigger template replication: ' + e.message, 'error');
    }
}

function showTemplateMessage(message, type = 'info') {
    let messageDiv = document.getElementById('template-message');
    if (!messageDiv) {
        messageDiv = document.createElement('div');
        messageDiv.id = 'template-message';
        messageDiv.style.padding = '12px';
        messageDiv.style.marginBottom = '16px';
        messageDiv.style.borderRadius = '4px';
        messageDiv.style.border = '1px solid';
        
        const selectElement = document.getElementById('template-select');
        selectElement.parentNode.insertBefore(messageDiv, selectElement);
    }
    
    // Set colors based on type
    if (type === 'loading') {
        messageDiv.style.backgroundColor = '#e6f3ff';
        messageDiv.style.borderColor = '#0078d4';
        messageDiv.style.color = '#0078d4';
        messageDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> ' + message;
    } else if (type === 'success') {
        messageDiv.style.backgroundColor = '#e6f5e6';
        messageDiv.style.borderColor = '#28a745';
        messageDiv.style.color = '#28a745';
        messageDiv.innerHTML = '<i class="bi bi-check-circle"></i> ' + message;
    } else if (type === 'error') {
        messageDiv.style.backgroundColor = '#ffe6e6';
        messageDiv.style.borderColor = '#dc3545';
        messageDiv.style.color = '#dc3545';
        messageDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + message;
    } else {
        messageDiv.style.backgroundColor = '#fff8e6';
        messageDiv.style.borderColor = '#ffc107';
        messageDiv.style.color = '#856404';
        messageDiv.innerHTML = '<i class="bi bi-info-circle"></i> ' + message;
    }
    
    messageDiv.style.display = 'block';
}

function hideTemplateMessage() {
    const messageDiv = document.getElementById('template-message');
    if (messageDiv) {
        messageDiv.style.display = 'none';
    }
}

function updateSpecsVisibility() {
    const templateSelect = document.getElementById('template-select');
    const alterCheckboxContainer = document.getElementById('alter-specs-container');
    const alterCheckbox = document.getElementById('alter-specs-checkbox');
    const specsSection = document.getElementById('vm-specs-section');
    
    const noTemplate = templateSelect.value === '';
    const alterChecked = alterCheckbox.checked;
    
    if (noTemplate) {
        // No template selected - always show specs, hide checkbox
        alterCheckboxContainer.style.display = 'none';
        specsSection.style.display = 'block';
    } else {
        // Template selected - show checkbox, show specs only if checked
        alterCheckboxContainer.style.display = 'block';
        if (alterChecked) {
            specsSection.style.display = 'block';
        } else {
            specsSection.style.display = 'none';
        }
    }
}

// Handle form submission
document.getElementById('create-class-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const name = document.getElementById('class-name').value.trim();
    const description = document.getElementById('class-description').value.trim();
    const poolSize = parseInt(document.getElementById('pool-size').value) || 0;
    const cpuCores = parseInt(document.getElementById('cpu-cores').value) || 2;
    const memoryMb = parseInt(document.getElementById('memory-mb').value) || 2048;
    const diskSizeGb = parseInt(document.getElementById('disk-size-gb').value) || 32;
    const templateVmid = parseInt(document.getElementById('template-select').value);
    
    if (!name) {
        alert('Please enter a class name.');
        return;
    }
    
    // Template is now optional
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating...';
    
    try {
        let templateId = null;
        
        // Only register template if one was selected
        if (templateVmid) {
            // Check if template is already registered, if not register it
            templateId = window.templateData.registered[templateVmid];
            
            if (!templateId) {
                // Template not registered yet - register it
                const selectedOption = document.querySelector(`#template-select option[value="${templateVmid}"]`);
                const templateName = selectedOption.dataset.name || `Template ${templateVmid}`;
                const templateNode = selectedOption.dataset.node;
                
                const templateResp = await fetch('/api/classes/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: templateName,
                        proxmox_vmid: templateVmid,
                        node: templateNode
                    })
                });
                const templateData = await templateResp.json();
                if (templateData.ok && templateData.template) {
                    templateId = templateData.template.id;
                } else {
                    throw new Error(templateData.error || 'Failed to register template');
                }
            }
        }
        
        // Create the class with the template ID
        const resp = await fetch('/api/classes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: description,
                pool_size: poolSize,
                cpu_cores: cpuCores,
                memory_mb: memoryMb,
                disk_size_gb: diskSizeGb,
                template_id: templateId
            })
        });
        
        const data = await resp.json();
        
        if (data.ok) {
            window.location.href = '/classes/' + data.class.id;
        } else {
            alert('Failed to create class: ' + (data.error || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-lg"></i> Create Class';
        }
    } catch (e) {
        console.error('Error creating class:', e);
        alert('Error creating class: ' + e.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-lg"></i> Create Class';
    }
});
</script>

{% endblock %}
